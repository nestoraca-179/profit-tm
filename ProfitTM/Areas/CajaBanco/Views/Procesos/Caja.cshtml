@{
    ViewBag.Title = "Cajas";
}
<style>
    input, select, textarea {
        border: solid 1px #d7d7d7;
        border-radius: 5px;
        box-shadow: none;
    }
    input[type=text] {
        padding: 5px;
    }
    table thead {
        background: #0277bd;
        color: #FFF;
    }
    table td {
        vertical-align: middle;
    }
    table thead tr th {
        padding: 15px 5px !important;
    }
    table tbody tr td {
        font-size: 14px;
        user-select: none;
    }
    .status {
        padding: 5px;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        color: #FFF;
    }
    .buttons-actions {
        justify-content: space-around;
        font-size: 20px;
        color: #6c6c6c;
        cursor: pointer;
    }
    .buttons-actions i {
        width: 20px;
    }
    .fa-exchange {
        color: #79a1ff;
    }
    .fa-eye {
        color: #ffb300;
    }
    table .fa-dollar-sign {
        color: #208c01;
    }
    .modal-dialog {
        min-width: 850px !important;
    }
    .controls {
        display: flex;
        align-items: center;
        margin: 10px 0;
    }
    .controls > * {
        width: 50%;
    }
    .modal-info .fas {
        font-size: 6em;
        padding: 5%;
    }
</style>
<script src="~/Scripts/angular-min.js"></script>
<div class="container-fluid container-boxes" style="display: none;" ng-app="Boxes" ng-controller="controller">
    <div class="row m-3">
        <div class="col d-flex align-items-center">
            <button class="btn btn-success d-flex align-items-center" ng-click="initBox()">
                <i class="fas fa-plus"></i>
                <p class="mx-2 my-0">Abrir nueva caja</p>
            </button>
        </div>
        <div class="col">
            <h2 class="text-center">Control de Cajas</h2>
        </div>
        <div class="col"></div>
    </div>
    <hr />
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Fecha Apertura</th>
                <th>Fecha Cierre</th>
                <th>Saldo Inicial</th>
                <th>Depósitos</th>
                <th>Retiros</th>
                <th>Ventas Contado</th>
                <th>Saldo en Caja</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="box in boxes | orderBy:'-DateS'">
                <td>{{ box.UserID }}</td>
                <td>{{ formatDate(box.DateS) }}</td>
                <td>{{ formatDate(box.DateE) }}</td>
                <td>{{ box.AmountInit.toFixed(2) }}</td>
                <td>{{ box.Incomes.toFixed(2) }}</td>
                <td>{{ box.Expenses.toFixed(2) }}</td>
                <td>{{ box.Sales.toFixed(2) }}</td>
                <td>{{ (box.AmountInit + box.Incomes - box.Expenses + box.Sales).toFixed(2) }}</td>
                <td ng-if="box.IsOpen">
                    <p class="status bg-success m-0">ABIERTO</p>
                </td>
                <td ng-if="!box.IsOpen">
                    <p class="status bg-danger m-0">CERRADO</p>
                </td>
                <td>
                    <div class="buttons-actions">
                        <i ng-show="box.IsOpen" class="fas fa-exchange" title="Generar Movimiento" data-toggle="modal" data-target="#modal-exchange" ng-click="setId(box.ID, box.AmountInit + box.Incomes - box.Expenses + box.Sales)"></i>
                        <i class="fas fa-eye mx-2" title="Ver Transacciones" ng-click="viewMovs(box.ID)"></i>
                        <i ng-show="box.IsOpen" class="fas fa-dollar-sign" title="Cerrar Caja" data-toggle="modal" data-target="#modal-dollar-sign"></i>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <!-- Modal Nuevo -->
    <div class="modal fade" id="modal-new" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Abrir Caja</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls my-5">
                        <label>Monto</label>
                        <div style="position: relative;">
                            <input type="text" id="initAmount" class="w-100" ng-model="initAmount" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" />
                            <label class="text-danger text-center w-100" id="text-error" style="font-weight: bold; font-size: 15px; color: #ff1919; position: absolute; top: 40px; left: 0;"></label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-success" ng-click="addBox(initAmount)">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Generar Movimiento -->
    <div class="modal fade" id="modal-exchange" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <form class="modal-dialog" id="form" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generar Movimiento</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls">
                        <label>Tipo de Movimiento</label>
                        <select ng-model="move.Type">
                            <option value="1">Ingreso</option>
                            <option value="2">Egreso</option>
                        </select>
                    </div>
                    <div class="controls">
                        <label>Monto</label>
                        <input type="text" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="move.Amount" />
                    </div>
                    <div class="controls">
                        <label>Comentario</label>
                        <textarea required style="font-size: 14px;" ng-model="move.Comment"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-success" ng-click="sendMov()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Ver Transacciones -->
    <div class="modal fade" id="modal-eye" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ver Transacciones</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table ng-if="movs.length > 0" class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="m in movs" style="font-size: 14px;">
                                <td>{{ m.ID }}</td>
                                <td>{{ m.UserID }}</td>
                                <td ng-if="m.Type == 1" style="font-weight: bold;" class="text-success">INGRESO (+)</td>
                                <td ng-if="m.Type == 2" style="font-weight: bold;" class="text-danger">EGRESO (-)</td>
                                <td>{{ m.Amount.toFixed(2) }}</td>
                                <td>{{ formatDate(m.Date) }}</td>
                                <td>{{ m.Comment }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p ng-if="movs.length == 0" class="text-center">No hay transacciones</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Cerrar Caja -->
    <div class="modal fade modal-info" id="modal-dollar-sign" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                @*<div class="modal-header"></div>*@
                <div class="modal-body">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">¿Desea cerrar caja?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Warning -->
    <div class="modal fade modal-info" id="modalWarning" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                @*<div class="modal-header"></div>*@
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h2 class="text-center">Ya tienes una caja abierta</h2>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Waiting -->
    <div class="modal fade modal-info" id="modalWaiting" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="background: rgba(0, 0, 0, .7);">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                @*<div class="modal-header"></div>*@
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-spinner fa-spin" style="color: #01579b;"></i>
                    </div>
                    <h2 class="text-center">Procesando...</h2>
                </div>
                @*<div class="modal-footer"></div>*@
            </div>
        </div>
    </div>
    <!-- Modal Success -->
    <div class="modal fade modal-info" id="modalSuccess" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                @*<div class="modal-header"></div>*@
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-check-circle" style="color: var(--bs-green)"></i>
                    </div>
                    <h2 class="text-center">{{ successMessage }}</h2>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="$('#modalWaiting').modal('hide');">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Error -->
    <div class="modal fade modal-info" id="modalError" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                @*<div class="modal-header"></div>*@
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-red)"></i>
                    </div>
                    <h2 class="text-center">Ha ocurrido un error</h2>
                    <p class="text-center">{{ errorMessage }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="$('#modalWaiting').modal('hide');">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel-loading p-3">
    <h4>Cargando cajas...</h4>
</div>
<script>
    var app = angular.module("Boxes", []);
    var user = '@ViewBag.username';
    var options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };

    app.controller("controller", function ($scope, $http) {

        $scope.initAmount = "0";
        $scope.move = { Type: "1" };
        $scope.boxId = "";
        $scope.totalBox = 0;

        $http.get("/api/ProfitTMApi/GetBoxes/")
            .then(function (response) {

                var res = response.data;
                if (res.Status = "OK") {

                    $scope.boxes = res.Result;
                    $(".container-boxes").removeAttr("style");
                    $(".panel-loading").css("display", "none");

                } else {
                    alert("Ha ocurrido un error " + res.Message);
                }

            });

        $scope.initBox = function () {

            let box = $scope.boxes.find(b =>
                b.UserID == user &&                 // busca caja que sea del mismo usuario
                compareDate(b.DateS, Date.now()) && // busca caja que sea del dia actual
                b.IsOpen                            // busca caja que este abierta
            );

            if (box != null)
                $("#modalWarning").modal("show");
            else {
                setTimeout(() => $('#initAmount').focus(), 1000);
                $("#modal-new").modal("show");
            }
        }

        $scope.viewMovs = function (id) {
            $scope.movs = $scope.boxes.find(b => b.ID == id).BoxMoves;
            $("#modal-eye").modal("show");
        }

        $scope.setId = function (id, total) {
            $scope.boxId = id;
            $scope.totalBox = total;
        }

        $scope.addBox = function (amount) {

            $("#text-error").text("");

            if (amount == "") {
                $("#text-error").text("**DEBES INGRESAR UN SALDO INICIAL**");
            } else {

                $("#modal-new").modal("hide");
                $("modalWaiting").modal("show");

                var box = {
                    UserID: user,
                    AmountInit: amount,
                    IsOpen: true
                };

                var req = {
                    method: 'POST',
                    url: '/api/ProfitTMApi/AddBox/',
                    data: box,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                $http(req).then(function (response) {

                    var res = response.data;
                    if (res.Status == "OK") {

                        var new_box = res.Result;
                        $scope.boxes.push(new_box);

                        $("#modalSuccess").modal("show");
                        $scope.successMessage = "Caja agregada con éxito";

                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }
                });

                $scope.initAmount = "0";
            }
        }

        $scope.sendMov = function () {

            if ($("#form")[0].checkValidity()) {

                $("#modal-exchange").modal("hide");
                $("modalWaiting").modal("show");

                var amount = parseFloat($scope.move.Amount);
                var total = parseFloat($scope.totalBox);

                if ($scope.move.Type == "2" && amount > total) {
                    $("#modalError").modal("show");
                    $scope.errorMessage = `Debes ingresar un monto menor al saldo disponible en caja (${total.toFixed(2)})`;
                    return;
                }

                $scope.move.BoxID = $scope.boxId;
                $scope.move.UserID = user;

                var req = {
                    method: 'POST',
                    url: '/api/ProfitTMApi/AddBoxMove/',
                    data: $scope.move,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                $http(req).then(function (response) {

                    var res = response.data;
                    if (res.Status == "OK") {

                        var new_move = res.Result;
                        $scope.boxes.find(b => b.ID == new_move.BoxID).BoxMoves.push(new_move);

                        if (new_move.Type == 1)
                            $scope.boxes.find(b => b.ID == new_move.BoxID).Incomes += new_move.Amount;
                        else if (new_move.Type == 2)
                            $scope.boxes.find(b => b.ID == new_move.BoxID).Expenses += new_move.Amount;

                        $scope.move = { Type: "1" };

                        $("#modalSuccess").modal("show");
                        $scope.successMessage = "Movimiento agregado con éxito";

                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }
                });
            }
        }

        $scope.formatDate = (date) => date != null ? new Date(date).toLocaleString("es-ES", options) : "";
    });

    function compareDate(d1, d2) {

        d1 = new Date(d1);
        d2 = new Date(d2);

        return d1.toLocaleDateString("en-US") == d2.toLocaleDateString("en-US");
    }

</script>