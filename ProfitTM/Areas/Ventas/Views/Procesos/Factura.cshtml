@{
    ViewBag.Title = "Factura";
}
<style>
    .container-invoices {
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-sizing: border-box;
    }
    .container-invoices > .row {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .container-invoices > .row hr {
        display: none;
    }
    .container-form .controls {
        margin: 0;
    }
    .col-sm-12.col-md-4.controls {
        width: auto;
    }
    .form-body .row {
        width: 100%;
        margin: 0;
        padding: 0;
    }
    .form-body .row .controls {
        margin: 0;
        padding: 0;
    }
    .cont-checks {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .cont-checks .label-check {
        width: 140px;
    }
    .cont-radios {
        height: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .btn-convert {
        display: flex;
        justify-content: center;
        align-items: end;
    }
    .btn-convert button {
        width: 100%;
    }
    .bottom {
        margin-top: 15px;
    }
    .modal-info .fas {
        font-size: 6em;
        padding: 5%;
    }
    tr.active {
        background: #0277bd !important;
    }
    tr.active td {
        color: #FFF !important;
    }
    @@media (max-width: 1199px) {
        .container-invoices, .container-invoices > .row {
            height: auto !important;
        }
        hr:not(.divider) {
            display: block !important;
        }
    }
</style>
<script src="~/Scripts/angular-min.js"></script>
<div class="container-fluid container-invoices" style="display: none;" ng-app="Invoices" ng-controller="controller">
    <div class="row">
        <div class="col-md-12 col-xl-3 container-list">
            <input type="text" id="input-invoices" class="form-control" placeholder="Buscar factura..." style="border: solid 1px #ced4da;" onkeyup="searchInvoice()" />
            <div class="list-table-invoices">
                <table class="table table-hover table-striped" id="table-invoices">
                    <thead>
                        <tr>
                            <th class="text-white">Código</th>
                            <th class="text-white">Cliente</th>
                        </tr>
                    </thead>
                    <tr ng-repeat="invoice in invoices" ng-class="{ active: invoices[index].doc_num == invoice.doc_num }" ng-click="selectInvoice(invoice.doc_num)" style="cursor: pointer;">
                        <td><i class="fas fa-caret-right mx-1" ng-show="invoices[index].doc_num == invoice.doc_num"></i>{{ invoice.doc_num }}</td>
                        <td>{{ invoice.co_cli }}</td>
                    </tr>
                </table>
            </div>
        </div>
        <hr class="divider" />
        <form action="" method="post" id="form" class="col-md-12 col-xl-9 container-form" onsubmit="return false;">
            <div class="form-header">
                <h3 class="text-center text-white"><i class="fas fa-file-invoice"></i> Factura</h3>
            </div>
            <div class="form-buttons">
                <div class="row">
                    <div class="col buttons-next-prev" ng-show="!adding">
                        <button type="button" class="btn btn-primary" ng-click="margin('s')">
                            <i class="fas fa-chevron-double-left"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="prev()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="next()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="margin('e')">
                            <i class="fas fa-chevron-double-right"></i>
                        </button>
                    </div>
                    <div class="col d-flex justify-content-end button-import" ng-show="!adding">
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalImportarPedido">
                            <i class="fas fa-file-search"></i> Importar Preliquidación
                        </button>
                    </div>
                    <div class="col buttons-save-cancel" ng-show="adding">
                        <button type="button" class="btn btn-danger" ng-click="adding = false; invoice = invoices[index]">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="submit" class="btn btn-success" ng-click="addInvoice()">
                            <i class="fas fa-save"></i>
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-tabs">
                <div class="row">
                    <button type="button" id="btn-general" class="col tablinks active" onclick="openTab(event, 'general')">General</button>
                    <button type="button" id="btn-adicionales" class="col tablinks" onclick="openTab(event, 'adicionales')">Adicionales</button>
                </div>
            </div>
            <div id="general" class="form-body" style="display: flex;">
                <div class="row">
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Número</label>
                            <input type="text" class="form-control" id="id" ng-model="invoice.doc_num" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Nro. Control</label>
                            <input type="text" class="form-control" id="n_control" ng-model="invoice.n_control" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Estatus</label>
                            <input type="text" class="form-control" id="status" ng-model="invoice.status" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Cliente</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="client" ng-model="invoice.co_cli" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalClients')" data-name="client"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Fec. Emis</label>
                            <input type="date" class="form-control" id="fec_emis" ng-model="invoice.fec_emis" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Transporte</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="trans" ng-model="invoice.co_tran" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalTrans')" data-name="trans"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Cond. Pago</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="cond" ng-model="invoice.co_cond" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalConds')" data-name="cond"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Fec. Venc</label>
                            <input type="date" class="form-control" id="fec_venc" ng-model="invoice.fec_venc" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Moneda</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="currency" ng-model="invoice.co_mone" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalCurrencies')" data-name="currency"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Vendedor</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="seller" ng-model="invoice.co_ven" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalSellers')" data-name="seller"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Fec. Reg</label>
                            <input type="date" class="form-control" id="fec_reg" ng-model="invoice.fec_reg" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Tasa</label>
                            <input type="text" class="form-control" id="tasa" ng-model="invoice.tasa" ng-disabled="!adding" ng-required="true" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-8">
                        <div class="controls">
                            <label>Descripción</label>
                            <input type="text" class="form-control" id="descrip" ng-model="invoice.descrip" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4 btn-convert">
                        <button class="btn btn-primary">Conversión</button>
                    </div>
                </div>
                <div class="bottom">
                    <h4 class="text-center">Items de la Factura</h4>
                    <table class="table">
                        <thead class="thead-dark">
                            <tr>
                                <th>N°</th>
                                <th>Artículo</th>
                                <th>Descripción</th>
                                <th>Almacén</th>
                                <th>Cantidad</th>
                                <th>IVA</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="reng in invoice.saFacturaVentaReng" style="cursor: pointer;">
                                <td>{{ reng.reng_num }}</td>
                                <td>{{ reng.co_art }}</td>
                                <td>{{ searchArt(reng.co_art) }}</td>
                                <td>{{ reng.co_alma }}</td>
                                <td>{{ reng.total_art }}</td>
                                <td>{{ reng.monto_imp }}</td>
                                <td>{{ reng.reng_neto }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr />
                    <div class="row">
                        <div class="col-sm-12 col-md-6 offset-md-6">
                            <div class="controls">
                                <label>Sub-Total</label>
                                <input type="text" class="form-control" id="subtotal" ng-model="invoice.total_bruto" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-6 offset-md-6">
                            <div class="controls">
                                <label>IVA</label>
                                <input type="text" class="form-control" id="iva" ng-model="invoice.monto_imp" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Saldo</label>
                                <input type="text" class="form-control" id="saldo" ng-model="invoice.saldo" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Total</label>
                                <input type="text" class="form-control" id="total" ng-model="invoice.total_neto" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="adicionales" class="form-body">
                <div class="left">
                    <div class="controls">
                        <label>Campo 1</label>
                        <input type="text" class="form-control" ng-model="invoice.campo1" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 3</label>
                        <input type="text" class="form-control" ng-model="invoice.campo3" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 5</label>
                        <input type="text" class="form-control" ng-model="invoice.campo5" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 7</label>
                        <input type="text" class="form-control" ng-model="invoice.campo7" ng-disabled="true" />
                    </div>
                </div>
                <div class="right">
                    <div class="controls">
                        <label>Campo 2</label>
                        <input type="text" class="form-control" ng-model="invoice.campo2" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 4</label>
                        <input type="text" class="form-control" ng-model="invoice.campo4" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 6</label>
                        <input type="text" class="form-control" ng-model="invoice.campo6" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Campo 8</label>
                        <input type="text" class="form-control" ng-model="invoice.campo8" ng-disabled="true" />
                    </div>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal 1 -->
    <div class="modal fade" id="modalClients" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cliente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar cliente..." onkeyup="search('modalClients')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        @{
                            foreach (var elem in ViewBag.clients)
                            {
                                <tr style="cursor: pointer" onclick="selectRow(this)">
                                    <td>@elem.co_cli</td>
                                    <td>@elem.cli_des</td>
                                </tr>
                            }
                        }
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalClients')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 2 -->
    <div class="modal fade" id="modalSellers" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Vendedor</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar vendedor..." onkeyup="search('modalSellers')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        @{
                            foreach (var elem in ViewBag.sellers)
                            {
                                <tr style="cursor: pointer" onclick="selectRow(this)">
                                    <td>@elem.co_ven</td>
                                    <td>@elem.ven_des</td>
                                </tr>
                            }
                        }
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalSellers')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 3 -->
    <div class="modal fade" id="modalConds" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cond. Pago</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar cond. pago..." onkeyup="search('modalConds')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        @{
                            foreach (var elem in ViewBag.conds)
                            {
                                <tr style="cursor: pointer" onclick="selectRow(this)">
                                    <td>@elem.co_cond</td>
                                    <td>@elem.cond_des</td>
                                </tr>
                            }
                        }
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalConds')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 4 -->
    <div class="modal fade" id="modalTrans" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Transporte</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar transporte..." onkeyup="search('modalTrans')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        @{
                            foreach (var elem in ViewBag.transports)
                            {
                                <tr style="cursor: pointer" onclick="selectRow(this)">
                                    <td>@elem.co_tran</td>
                                    <td>@elem.des_tran</td>
                                </tr>
                            }
                        }
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalTrans')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 5 -->
    <div class="modal fade" id="modalCurrencies" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Moneda</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar moneda..." onkeyup="search('modalCurrencies')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        @{
                            foreach (var elem in ViewBag.currencies)
                            {
                                <tr style="cursor: pointer" onclick="selectRow(this)">
                                    <td>@elem.co_mone</td>
                                    <td>@elem.mone_des</td>
                                </tr>
                            }
                        }
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalCurrencies')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Search Order -->
    <div class="modal fade" id="modalImportarPedido" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Preliquidación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div style="width: 80%; margin: 50px auto; display: flex; align-items: center;">
                        <label style="flex: 1;">Ingrese Nro. de Preliquidación</label>
                        <div class="input-search" style="flex: 1;">
                            <input type="text" class="form-control" id="preliq" ng-model="idOrder" />
                            <i class="fas fa-search" role="button"></i>
                        </div>
                    </div>
                    <label class="text-danger text-center w-100" id="text-error"></label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" ng-click="searchOrder(idOrder)">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel-loading p-3">
    <h4>Cargando modulo de facturación...</h4>
</div>
<script>
    var app = angular.module("Invoices", []);
    var invoices = @Html.Raw(ViewBag.invoices);
    var arts = @Html.Raw(ViewBag.arts);

    for (var item of invoices) {
        item.fec_emis = new Date(parseInt(item.fec_emis.substr(6)));
        item.fec_venc = new Date(parseInt(item.fec_venc.substr(6)));
        item.fec_reg = new Date(parseInt(item.fec_reg.substr(6)));
        item.fe_us_in = new Date(parseInt(item.fe_us_in.substr(6)));
        item.fe_us_mo = new Date(parseInt(item.fe_us_mo.substr(6)));
    }

    $(document).ready(function () {
        $(".container-invoices").removeAttr("style");
        $(".panel-loading").css("display", "none");
    });

    app.controller("controller", function ($scope, $http) {

        $scope.index = 0;
        $scope.invoices = invoices;
        $scope.invoice = invoices[$scope.index];
        $scope.adding = false;

        $scope.next = function () {
            if ($scope.index == (invoices.length - 1)) {
                $scope.index = 0;
            } else {
                $scope.index++;
            }

            $scope.invoice = invoices[$scope.index];
        }

        $scope.prev = function () {
            if ($scope.index == 0) {
                $scope.index = invoices.length - 1;
            } else {
                $scope.index--;
            }

            $scope.invoice = invoices[$scope.index];
        }

        $scope.selectInvoice = function (id) {
            if ($scope.adding) {
                alert("Debes terminar de agregar la factura");
            } else if ($scope.editing) {
                alert("Debes terminar de modificar la factura " + $scope.invoice.doc_num);
            } else {
                $scope.invoice = invoices.find(i => i.doc_num == id);
                $scope.index = invoices.indexOf($scope.invoice);
                $scope.invoices = invoices;
                $("#input-invoices").val("");
                searchInvoice();
            }
        }

        $scope.margin = function (p) {
            if (p == "s") {
                $scope.index = 0;
                $scope.invoice = invoices[0];
            } else if (p == "e") {
                $scope.index = invoices.length - 1;
                $scope.invoice = invoices[invoices.length - 1];
            }
        }

        $scope.searchArt = function (id) {
            return arts.find(a => a.co_art == id).art_des;
        }

        $scope.searchOrder = function (id) {

            $http.get("/api/ProfitTMApi/GetOrder/" + id)
                .then(function (response) {

                    var res = response.data;

                    if (res.Status == "OK") {

                        $("#modalImportarPedido").modal("hide");

                        $scope.invoice = res.Result;
                        $scope.invoice.saFacturaVentaReng = res.Result.saPedidoVentaReng;

                        $scope.invoice.doc_num = "";
                        $scope.invoice.n_control = "";
                        $scope.invoice.fec_emis = new Date($scope.invoice.fec_emis);
                        $scope.invoice.fec_venc = new Date($scope.invoice.fec_venc);
                        $scope.invoice.fec_reg = new Date($scope.invoice.fec_reg);
                        $scope.invoice.fe_us_in = new Date($scope.invoice.fe_us_in);
                        $scope.invoice.fe_us_mo = new Date($scope.invoice.fe_us_mo);

                        for (var reng of $scope.invoice.saFacturaVentaReng) {
                            reng.tipo_doc = "PCLI";
                            reng.num_doc = id;
                            reng.rowguid_doc = reng.rowguid;
                        }

                        console.log($scope.invoice);

                        $("#preliq").val("");
                        $("#text-error").text("");
                        $scope.adding = true;

                    } else {
                        if (res.Message == "0")
                            $("#text-error").text("*PRELIQUIDACIÓN NO ENCONTRADA*");
                        else if (res.Message == "1")
                            $("#text-error").text("*PRELIQUIDACIÓN BLOQUEADA*");
                        else
                            $("#text-error").text("*HA OCURRIDO UN ERROR*");
                    }

                }, function () { $("#text-error").text("*HA OCURRIDO UN ERROR*"); });
        }

        $scope.addInvoice = function () {

            if ($("#form")[0].checkValidity()) {

                $("#form input, #form textarea").change();
                $("#modalWaiting").modal("show");

                $scope.invoice.fec_emis = origDate($scope.invoice.fec_emis);
                $scope.invoice.fec_venc = origDate($scope.invoice.fec_venc);
                $scope.invoice.fec_reg = origDate($scope.invoice.fec_reg);

                for (var ind in $scope.invoice) {
                    if ($scope.invoice[ind] === "")
                        $scope.invoice[ind] = null;
                }

                console.log($scope.client);

                var req = {
                    method: 'POST',
                    url: '/api/ProfitTMApi/AddInvoiceFromOrder/',
                    data: $scope.invoice,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                $http(req).then(function (response) {

                    /*console.log(response.data);
                    var res = response.data;

                    $("#modalWaiting").modal("hide");
                    if (res.Status == "OK") {
                        $("#modalSuccess").modal("show");
                        $scope.successMessage = "El cliente se ha agregado con éxito";
                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }*/

                });

            } else {
                var id = $($("#form :invalid")[0]).closest(".form-body")[0].id;
                $("#btn-" + id).trigger("click", event);
            }
        }

    });

    function setStatus(status) {

        var value;

        if (status == 0)
            value = "NO PROCESADA";
        else if (status == 1)
            value = "PARC. PROCESADA";
        else if (status == 2)
            value = "PROCESADA";

        return value;
    }

    function origDate(value) {

        var timeOffset = value.getTimezoneOffset() * 60000;
        var date = new Date(value.getTime() - timeOffset).toUTCString();

        return new Date(date);
    }

    function openModal(elem, modal) {

        var previous = elem.previousElementSibling;

        if (!previous.disabled) {

            $("#" + modal).find("#name-input").val($(elem).data("name"));
            $("#" + modal).modal("show");

        }
    }

    function search(modal) {
        var value = $("#" + modal).find("input[type=text]").val().toLowerCase(),
            table = $("#" + modal).find("#results")[0];

        for (var i = 0; i < table.rows.length; i++) {

            var row = table.rows[i];
            var elems = row.getElementsByTagName("td");

            var val1 = elems[0].innerHTML.toLocaleLowerCase(), val2 = elems[1].innerHTML.toLocaleLowerCase();

            if (!val1.includes(value) && !val2.includes(value))
                row.style.display = "none";
            else
                row.style.display = "";
        }
    }

    function selectRow(elem) {
        var previous = document.getElementsByClassName("selected-row")[0];

        if (previous != null) {
            previous.classList.remove("selected-row");
        }

        elem.classList.add("selected-row");
    }

    function saveRow(modal) {
        var item = document.getElementsByClassName("selected-row")[0];

        if (item != null) {
            var elem = item.children[0],
                value = elem.innerHTML,
                input = $("#" + modal).find("#name-input").val();

            $("#" + input).val(value.trim());
            $(".selected-row")[0].classList.remove("selected-row");
            $("#" + modal).find("input[type=text]").val("");
            $("#" + modal).find("button[name=search-btn]").trigger("click");

            $("#" + modal).modal("hide");
        } else {
            alert("Debes seleccionar un item");
        }
    }

    function openTab(e, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("form-body");

        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tablinks");

        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "flex";
        e.target.className += " active";
    }

    function searchInvoice() {
        var value = $("#input-invoices").val().toLowerCase(),
            table = $("#table-invoices")[0];

        for (var i = 1; i < table.rows.length; i++) {

            var row = table.rows[i];
            var elems = row.getElementsByTagName("td");

            var val1 = elems[0].innerHTML.toLocaleLowerCase(), val2 = elems[1].innerHTML.toLocaleLowerCase();

            if (!val1.includes(value) && !val2.includes(value))
                $(row).slideUp(); // row.style.display = "none";
            else
                row.style.display = "";
        }
    }

</script>