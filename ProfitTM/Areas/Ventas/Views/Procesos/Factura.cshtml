@{
    ViewBag.Title = "Factura";
}
<style>
    input, select, textarea {
        border: solid 1px #d7d7d7;
        border-radius: 5px;
        box-shadow: none;
    }
    input[disabled] {
        pointer-events: none;
    }
    .container-invoices {
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-sizing: border-box;
    }
    .container-invoices > .row {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .container-invoices > .row hr {
        display: none;
    }
    .container-form .controls {
        margin: 0;
    }
    .col-sm-12.col-md-4.controls {
        width: auto;
    }
    .form-body .row {
        width: 100%;
        margin: 0;
        padding: 0;
    }
    .form-body .row .controls {
        margin: 0;
        padding: 0;
    }
    .cont-checks {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .cont-checks .label-check {
        width: 140px;
    }
    .cont-radios {
        height: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .btn-convert {
        display: flex;
        justify-content: center;
        align-items: end;
    }
    .btn-convert button {
        width: 100%;
    }
    .bottom {
        margin-top: 15px;
    }
    .modal-info .fas {
        font-size: 6em;
        padding: 5%;
    }
    tr.active {
        background: #0277bd !important;
    }
    tr.active td {
        color: #FFF !important;
    }
    .field-active {
        background: #7af4af !important;
    }
    .d-flex.justify-content-evenly > button {
        width: 25px;
        height: 25px;
        padding: 0;
        font-size: 10px;
    }
    /* ESTILOS MODAL NUEVO */
    .invoice-totals {
        display: flex;
        flex-wrap: wrap;
        margin: 10px 0;
    }
    .invoice-totals p {
        margin: 0;
    }
    .invoice-totals p:not(.total-usd) {
        flex: 1;
        font-size: 16px;
    }
    .invoice-totals p.total-bs, .invoice-totals p.total-usd{
        text-align: right;
    }
    .invoice-totals p.total-usd {
        width: 100%;
        flex: auto;
        font-size: 14px;
        font-weight: bold;
    }
    #details-table thead {
        background: #0277bd;
        color: #FFF;
    }
    #details-table thead tr th {
        padding: 10px;
    }
    #details-table tbody tr td {
        font-size: 12px;
    }
    .header-totals {
        background: #0277bd;
    }
    .buttons-totals {
        display: flex;
    }
    .buttons-totals button, .buttons-totals button:active, .buttons-totals button:focus, .buttons-totals button:disabled {
        background: #19549f;
        color: #FFF;
        border: 0;
        border-radius: 0;
    }
    .buttons-totals button:hover {
        background: #052042;
        color: #FFF;
        border: 0;
    }
    #modalEfectivo .controls, #modalTransf .controls,
    #modalRetenIva .controls, #modalRetenIslr .controls {
        display: flex;
        align-items: center;
        margin: 10px 0;
    }
    #modalEfectivo .controls > *, #modalTransf .controls > *,
    #modalRetenIva .controls > *, #modalRetenIslr .controls > * {
        width: 50%;
    }
    #modalEfectivo .controls input, #modalTransf .controls input, 
    #modalRetenIva .controls input, #modalRetenIslr .controls input {
        padding: 5px;
    }
    @@media (max-width: 767px) {
        .btn-convert {
            margin-top: 15px;
        }
    }
    @@media (max-width: 1199px) {
        .container-invoices, .container-invoices > .row {
            height: auto !important;
        }
        hr:not(.divider) {
            display: block !important;
        }
        .button-import .btn {
            margin: 2px;
        }
        .buttons-next-prev {
            justify-content: center !important;
            margin: 5px 0;
        }
        .button-import {
            flex-wrap: wrap;
            justify-content: center !important;
            margin: 5px 0;
        }
    }
</style>
<script src="~/Scripts/angular-min.js"></script>
<div class="container-fluid container-invoices" id="container-invoices" style="display: none;" ng-app="Invoices" ng-controller="controller" ng-show="boxOpen == true">
    <div class="row">
        <div class="col-md-12 col-xl-3 container-list">
            <input type="text" id="input-invoices" class="form-control" placeholder="Buscar factura..." style="border: solid 1px #ced4da;" onkeyup="searchInvoice()" />
            <div class="list-table-invoices">
                <table class="table table-hover table-striped" id="table-invoices">
                    <thead>
                        <tr>
                            <th class="text-white">Código</th>
                            <th class="text-white">Cliente</th>
                        </tr>
                    </thead>
                    <tr ng-repeat="invoice in invoices" ng-class="{ active: invoices[index].doc_num == invoice.doc_num }" ng-click="selectInvoice(invoice.doc_num)" style="cursor: pointer;">
                        <td><i class="fas fa-caret-right mx-1" ng-show="invoices[index].doc_num == invoice.doc_num"></i>{{ invoice.doc_num }}</td>
                        <td>{{ invoice.co_cli }}</td>
                    </tr>
                </table>
            </div>
            <button type="button" class="btn btn-primary mt-2" ng-click="loadInvoices()">Cargar más facturas</button>
        </div>
        <hr class="divider" />
        <form action="" method="post" id="form" class="col-md-12 col-xl-9 container-form" onsubmit="return false;">
            <div class="form-header">
                <h3 class="text-center text-white"><i class="fas fa-file-invoice"></i> Factura</h3>
            </div>
            <div class="form-buttons">
                <div class="row">
                    <div class="col-sm-12 col-xl-4 buttons-next-prev" ng-show="!new && !adding">
                        <button type="button" class="btn text-white" style="background: #810be3; min-width: auto; padding: 0 7px;" ng-click="initAddInvoice()" ng-disabled="template == null">
                            <i class="fas fa-plus"></i> Nuevo
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="margin('s')">
                            <i class="fas fa-chevron-double-left"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="prev()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="next()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-primary" ng-click="margin('e')">
                            <i class="fas fa-chevron-double-right"></i>
                        </button>
                    </div>
                    <div class="col-sm-12 col-xl-8 d-flex justify-content-end button-import p-0 col-auto" ng-show="!new && !adding">
                        <p ng-if="invoice.impresa" class="my-0 d-flex align-items-center text-center" style="margin-right: 5px;"><b>Doc. Impreso</b></p>
                        <button type="button" class="btn" style="background: #ec9d0b; color: #FFF; margin-right: 5px;" ng-disabled="invoice.anulado" ng-click="print(invoice.doc_num)">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <p ng-if="invoice.anulado" class="my-0 d-flex align-items-center text-center" style="margin-right: 5px;"><b>Anulado</b></p>
                        <button type="button" class="btn" data-toggle="modal" data-target="#modalAnularFactura" style="background: #ff5400; color: #FFF; margin-right: 5px;" ng-disabled="!us.AllowCancel || invoice.anulado || invoice.status != 0">
                            <i class="fas fa-times"></i> Anular
                        </button>
                        <button type="button" class="btn" style="background: #0b8ece; color: #FFF; margin-right: 5px;" ng-disabled="!us.AllowCollect || (invoice.co_cond.trim() == '002' && sucur != '002') || invoice.anulado || invoice.saldo == 0" ng-click="initLoadCollect()">
                            <i class="fas fa-dollar-sign"></i> Cobrar
                        </button>
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalSearchOrder" onclick="focusField('#n_preliq')">
                            <i class="fas fa-file-search"></i> Importar Preliquidación
                        </button>
                    </div>
                    <div class="col buttons-save-cancel" ng-show="new">
                        <button type="button" class="btn btn-danger" ng-click="new = false; confirm = false; manual = false; invoice = invoices[index];">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="submit" class="btn btn-success" ng-click="addNewInvoice()">
                            <i class="fas fa-save"></i>
                            Guardar
                        </button>
                        <div class="d-flex align-items-center px-2">
                            <label><input type="checkbox" ng-model="manual" /> No mostrar en Libro de Ventas</label>
                        </div>
                    </div>
                    <div class="col buttons-save-cancel" ng-show="adding">
                        <button type="submit" class="btn btn-success" ng-click="confirmAdd()">
                            <i class="fas fa-save"></i>
                            Guardar Documento Importado
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#modalDelete">
                            <i class="fas fa-trash"></i>
                            Eliminar Documento Importado
                        </button>
                        <div style="width: 10px;"></div>
                        <button type="button" class="btn btn-danger" ng-click="adding = false; confirm = false; invoice = invoices[index];">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-tabs">
                <div class="row">
                    <button type="button" id="btn-general" class="col tablinks active" onclick="openTab(event, 'general')">General</button>
                    <button type="button" id="btn-adicionales" class="col tablinks" onclick="openTab(event, 'adicionales')">Adicionales</button>
                </div>
            </div>
            <div id="general" class="form-body" style="display: flex;">
                <div class="row">
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Número</label>
                            <input type="text" class="form-control" id="id" ng-model="invoice.doc_num" ng-disabled="!manual" ng-required="manual" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Nro. Control</label>
                            <input type="text" class="form-control" id="n_control" ng-model="invoice.n_control" ng-disabled="!confirm && !manual" ng-required="manual" onkeypress="$('#n_control').removeAttr('style');" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-4">
                        <div class="controls">
                            <label>Estatus</label>
                            <input type="text" class="form-control" id="status" ng-model="invoice.estatus" ng-disabled="true" ng-required="true" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="controls">
                            <label>Cliente</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="client" ng-model="invoice.co_cli" ng-disabled="!new" ng-required="true" style="flex: 1;" onkeypress="return false;" />
                                <input type="text" class="form-control" id="des_client" ng-model="invoice.saCliente.cli_des" ng-disabled="!new" ng-required="true" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalClients')" data-name="client"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Fec. Emis</label>
                            <input type="date" class="form-control" id="fec_emis" ng-model="invoice.fec_emis" ng-disabled="!manual" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Transporte</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="trans" ng-model="invoice.co_tran" ng-disabled="true" ng-required="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalTrans')" data-name="trans"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="controls">
                            <label>Cond. Pago</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="cond" ng-model="invoice.co_cond" ng-disabled="!new && !adding" ng-required="true" ng-readonly="true" style="flex: 1;" />
                                <input type="text" class="form-control" id="des_cond" ng-model="invoice.saCondicionPago.cond_des" ng-disabled="!new && !adding" ng-required="true" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalConds')" data-name="cond"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Fec. Venc</label>
                            <input type="date" class="form-control" id="fec_venc" ng-model="invoice.fec_venc" ng-disabled="!manual" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Moneda</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="currency" ng-model="invoice.co_mone" ng-disabled="!new" ng-required="true" ng-readonly="true" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalCurrencies')" data-name="currency"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="controls">
                            <label>Vendedor</label>
                            <div class="input-search">
                                <input type="text" class="form-control" id="seller" ng-model="invoice.co_ven" ng-disabled="!new" ng-required="true" ng-readonly="true" style="flex: 1;" />
                                <input type="text" class="form-control" id="des_seller" ng-model="invoice.saVendedor.ven_des" ng-disabled="!new" ng-required="true" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                                <i class="fas fa-search" role="button" onclick="openModal(this, 'modalSellers')" data-name="seller"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Fec. Reg</label>
                            <input type="date" class="form-control" id="fec_reg" ng-model="invoice.fec_reg" ng-disabled="!manual" ng-required="true" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3">
                        <div class="controls">
                            <label>Tasa</label>
                            <input type="text" class="form-control" id="tasa" ng-model="invoice.tasa" ng-disabled="!new && !adding" ng-required="true" ng-change="update(invoice.tasa)" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-9">
                        <div class="controls">
                            <label>Descripción</label>
                            <input type="text" class="form-control" id="descrip" ng-model="invoice.descrip" ng-disabled="!new && !adding" ng-required="false" />
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-3 btn-convert">
                        <button type="button" class="btn btn-primary" ng-click="convert()">Conversión</button>
                    </div>
                </div>
                <div class="row mt-3" ng-if="new">
                    <div class="col">
                        <button type="button" class="btn btn-primary" ng-click="initItem(false, null)">
                            <i class="fas fa-plus"></i> Agregar Item
                        </button>
                    </div>
                </div>
                <div class="bottom" style="padding: 0 0 10px 0;">
                    <h4 class="text-center text-white form-header"><i class="fas fa-list"></i> Items de la Factura</h4>
                    <div style="padding: 0 10px; overflow-x: auto;">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>N°</th>
                                    <th>Artículo</th>
                                    <th>Descripción</th>
                                    <th>Almacén</th>
                                    <th>Cantidad</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th ng-if="new"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="reng in invoice.saFacturaVentaReng" style="cursor: pointer;">
                                    <td>{{ reng.reng_num }}</td>
                                    <td>{{ reng.co_art }}</td>
                                    <td>{{ searchArt(reng.co_art) }}</td>
                                    <td>{{ reng.co_alma }}</td>
                                    <td>{{ reng.total_art }}</td>
                                    <td ng-show="!converted">{{ reng.monto_imp }}</td>
                                    <td ng-show="converted" class="field-active">{{ reng.monto_imp_om }}</td>
                                    <td ng-show="!converted">{{ reng.reng_neto }}</td>
                                    <td ng-show="converted" class="field-active">{{ reng.reng_neto_om }}</td>
                                    <td ng-if="new" class="d-flex justify-content-evenly">
                                        <button type="button" class="btn btn-primary" ng-click="initItem(true, reng);">
                                            <i class="fas fa-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger" ng-click="updateAmounts(invoice, reng, invoice.saFacturaVentaReng, 3);">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-sm-12 col-md-6 offset-md-6">
                            <div class="controls">
                                <label>Sub-Total</label>
                                <input type="text" class="form-control" id="subtotal" ng-model="invoice.total_bruto" ng-show="!converted" ng-disabled="true" ng-required="true" />
                                <input type="text" class="form-control field-active" id="subtotal_om" ng-model="invoice.total_bruto_om" ng-show="converted" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-6 offset-md-6">
                            <div class="controls">
                                <label>IVA</label>
                                <input type="text" class="form-control" id="iva" ng-model="invoice.monto_imp" ng-show="!converted" ng-disabled="true" ng-required="true" />
                                <input type="text" class="form-control field-active" id="iva_om" ng-model="invoice.monto_imp_om" ng-show="converted" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Saldo</label>
                                <input type="text" class="form-control" id="saldo" ng-model="invoice.saldo" ng-show="!converted" ng-disabled="true" ng-required="true" />
                                <input type="text" class="form-control field-active" id="saldo_om" ng-model="invoice.saldo_om" ng-show="converted" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Total</label>
                                <input type="text" class="form-control" id="total" ng-model="invoice.total_neto" ng-show="!converted" ng-disabled="true" ng-required="true" />
                                <input type="text" class="form-control field-active" id="total_om" ng-model="invoice.total_neto_om" ng-show="converted" ng-disabled="true" ng-required="true" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="adicionales" class="form-body">
                <div class="left">
                    <div class="controls" ng-if="new">
                        <label>¿Como cancela el cliente?</label>
                        <select class="form-control" ng-model="invoice.typePay" ng-change="updateUSD(invoice.typePay)" style="-webkit-appearance: button; -moz-appearance: button;">
                            <option value="1">Monto Completo ($USD)</option>
                            <option value="2">Monto Completo ($USD) - Retenciones</option>
                            <option value="3">Otro monto</option>
                        </select>
                    </div>
                    <div class="controls">
                        <label>Contenedor</label>
                        <textarea class="form-control" ng-model="invoice.dir_ent" ng-disabled="!new && !adding"></textarea>
                    </div>
                    <br />
                    <div class="controls">
                        <label>Ag. Aduanal</label>
                        <input type="text" class="form-control" ng-model="invoice.campo1" ng-disabled="!new" />
                    </div>
                    <div class="controls">
                        <label>No. Doc.</label>
                        <input type="text" class="form-control" ng-model="invoice.campo3" ng-disabled="!new && !adding" />
                    </div>
                    <div class="controls">
                        <label>Destino</label>
                        <input type="text" class="form-control" ng-model="invoice.campo5" ng-disabled="!new" />
                    </div>
                    <div class="controls">
                        <label>Buque</label>
                        <input type="text" class="form-control" ng-model="invoice.campo7" ng-disabled="!new" />
                    </div>
                </div>
                <div class="right">
                    <div class="controls" ng-if="new">
                        <label>Porcentaje de Retenciones</label>
                        <div class="d-flex justify-content-between">
                            <fieldset>
                                <label class="label-radio"><input type="radio" value="75" ng-model="invoice.porc_ret_iva" ng-change="updateUSD('2')" ng-disabled="invoice.typePay != '2'" /> IVA 75%</label>
                                <label class="label-radio mx-3"><input type="radio" value="100" ng-model="invoice.porc_ret_iva" ng-change="updateUSD('2')" ng-disabled="invoice.typePay != '2'" /> IVA 100%</label>
                            </fieldset>
                            <fieldset>
                                <label class="label-radio mx-3"><input type="radio" value="2" ng-model="invoice.porc_ret_islr" ng-change="updateUSD('2')" ng-disabled="invoice.typePay != '2'" /> ISLR 2%</label>
                                <label class="label-radio"><input type="radio" value="5" ng-model="invoice.porc_ret_islr" ng-change="updateUSD('2')" ng-disabled="invoice.typePay != '2'" /> ISLR 5%</label>
                            </fieldset>
                        </div>
                    </div>
                    <div class="controls">
                        <label>Divisas</label>
                        <textarea class="form-control" ng-model="invoice.comentario" ng-disabled="!new || invoice.typePay != '3'"></textarea>
                    </div>
                    <br />
                    <div class="controls">
                        <label>Fec. Viaje</label>
                        <input type="text" class="form-control" ng-model="invoice.campo2" ng-disabled="!new" />
                    </div>
                    <div class="controls">
                        <label>Pto. Embq.</label>
                        <input type="text" class="form-control" ng-model="invoice.campo4" ng-disabled="!new" />
                    </div>
                    <div class="controls">
                        <label>Mercancía</label>
                        <input type="text" class="form-control" ng-model="invoice.campo6" ng-disabled="!new" />
                    </div>
                    <div class="controls">
                        <label>No. Viaje</label>
                        <input type="text" class="form-control" ng-model="invoice.campo8" ng-disabled="!new" />
                    </div>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Procesando -->
    <div class="modal fade modal-info" id="modalWaiting" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="background: rgba(0, 0, 0, .7);">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-spinner fa-spin" style="color: #01579b;"></i>
                    </div>
                    <h2 class="text-center">Procesando...</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Confirmacion Num. Control Automatico -->
    <div class="modal fade modal-info" id="modalConfirm" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">El número de control será generado automáticamente. ¿Desea continuar?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" ng-click="confirm = true" onclick="alertField()" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" ng-click="addInvoice()">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Confirmacion Num. Control Manual -->
    <div class="modal fade modal-info" id="modalSend" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">Ha ingresado el número de control {{ invoice.n_control }}. ¿Desea continuar?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" ng-click="confirm = true" onclick="alertField()" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" ng-click="addInvoice()">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Anular Factura -->
    <div class="modal fade modal-info" id="modalAnularFactura" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">¿Desea anular la factura N° {{ invoice.doc_num }}?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" ng-click="cancelInvoice(invoice.doc_num)">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Buscar Preliquidacion -->
    <div class="modal fade" id="modalSearchOrder" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051;">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Importar Preliquidación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" onclick="$('#text-error').text('');">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div style="width: 80%; margin: 50px auto; display: flex; align-items: center;">
                        <label style="flex: 1;">Ingrese Nro. de Preliquidación</label>
                        <div class="input-search" style="flex: 1; position: relative;">
                            <input type="text" class="form-control" id="n_preliq" ng-model="idOrder" ng-keypress="detectEnter($event.originalEvent)" />
                            <i class="fas fa-search" role="button" id="btn-preliq" ng-click="getOrders()" data-name="n_preliq"></i>
                            <label class="text-danger text-center w-100" id="text-error" style="font-weight: bold; font-size: 15px; color: #ff1919; position: absolute; top: 130%;"></label>
                            <label class="text-primary text-center w-100" id="text-search" style="font-weight: bold; font-size: 15px; color: #ff1919; position: absolute; top: 130%;"></label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#text-error').text('');">Cerrar</button>
                    <button type="button" class="btn btn-primary" ng-click="searchOrder(idOrder)">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Confirmar Monto Cobro -->
    <div class="modal fade modal-info" id="modalConfirmarMonto" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-hidden="true" style="background: rgba(0, 0, 0, 0.7)">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">Ha ingresado el monto {{ setSeparator(rengTP.mont_doc) }}. ¿Desea generar el cobro?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" ng-click="sendCollect()">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal OK -->
    <div class="modal fade modal-info" id="modalSuccess" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-check-circle" style="color: var(--bs-green)"></i>
                    </div>
                    <h2 class="text-center">{{ successMessage }}</h2>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="$('#modalWaiting').modal('hide');" ng-click="loadCollect()">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Error -->
    <div class="modal fade modal-info" id="modalError" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-red)"></i>
                    </div>
                    <h2 class="text-center">Ha ocurrido un error</h2>
                    <p class="text-center">{{ errorMessage }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="$('#modalWaiting').modal('hide');">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Eliminar Preliquidacion -->
    <div class="modal fade modal-info" id="modalDelete" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">¿Desea eliminar la preliquidación N° {{ idOrder }}?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" ng-click="deleteOrder(idOrder)">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Agregar Item Factura -->
    <div class="modal fade" id="modalItem" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051;">
        <form class="modal-dialog" role="document" style="max-width: 800px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 ng-if="!editItem" class="modal-title">Agregar Item</h5>
                    <h5 ng-if="editItem" class="modal-title">Editar Item</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="row">
                        <div class="col-sm-12 col-md-9">
                            <div class="controls">
                                <label>Articulo</label>
                                <div class="input-search">
                                    <input type="text" class="form-control" id="art" ng-model="reng.co_art" ng-disabled="!new" ng-required="true" style="flex: 1;" onkeypress="return false;" />
                                    <input type="text" class="form-control" id="des_art" ng-disabled="!new" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                                    <i class="fas fa-search" role="button" onclick="openModal(this, 'modalArts')" data-name="art"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Cantidad</label>
                                <input type="number" class="form-control" id="quantity" ng-model="reng.total_art" ng-disabled="!new" ng-required="true" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-change="updatePriceItem()" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label ng-if="!manual">Precio Unit. $USD</label>
                                <label ng-if="manual">Precio Unit. Bs. D</label>
                                <input type="text" class="form-control" id="price_usd" ng-model="reng.prec_vta_om" ng-disabled="!new" ng-required="true" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-change="updatePriceItem()" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label ng-if="!manual">Total $USD (Sin IVA)</label>
                                <label ng-if="manual">Total Bs. D (Sin IVA)</label>
                                <input type="text" class="form-control" id="total_usd" ng-model="reng.reng_neto_om" ng-disabled="!new" ng-required="true" ng-readonly="true" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label ng-if="!manual">Monto IVA $USD</label>
                                <label ng-if="manual">Monto IVA Bs. D</label>
                                <input type="text" class="form-control" id="iva_usd" ng-model="reng.monto_imp_om" ng-disabled="!new" ng-required="true" ng-readonly="!manual" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button ng-if="!editItem" type="submit" class="btn btn-primary" ng-click="setItem(reng, 1)">Agregar</button>
                    <button ng-if="editItem" type="submit" class="btn btn-primary" ng-click="setItem(reng, 2)">Editar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Agregar Cobro -->
    <div class="modal fade modal-info" id="modalWithCollect" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 800px; margin: 0 auto;">
            <div class="modal-content">
                <div class="modal-body" style="max-height: 450px; overflow-y: auto; padding: 45px;">
                    <div style="display: flex; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--bs-yellow)"></i>
                    </div>
                    <h3 class="text-center">¿Desea cargar el cobro de la factura N° {{ invoice.doc_num }}?</h3>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button type="button" style="width: 70px;" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="button" style="width: 70px;" class="btn btn-success" data-dismiss="modal" ng-click="initLoadCollect()">Sí</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Cobro -->
    <div class="modal fade" id="modalCobrar" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051;">
        <form id="form-collect" class="modal-dialog" role="document" style="max-width: 800px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cobrar de contado</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" onclick="$('#des_cta').val('')" ng-click="rengTP = { forma_pag: 'EF' }">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="row">
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>Forma de Cobro</label>
                                <select class="form-control" ng-model="rengTP.forma_pag" style="-webkit-appearance: button; -moz-appearance: button;">
                                    <option ng-if="invoice.co_cond.trim() == '002'" value="EF">Efectivo ($USD)</option>
                                    <option ng-if="invoice.co_cond.trim() == '001'" value="TP">Transferencia</option>
                                    <option ng-if="invoice.co_cond.trim() == '001'" value="DP">Depósito</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>Nro. Documento</label>
                                <input type="text" class="form-control" id="num_doc" ng-model="rengTP.num_doc" ng-disabled="rengTP.forma_pag == 'EF'" ng-required="rengTP.forma_pag != 'EF'" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>Fecha</label>
                                <input type="date" class="form-control" id="fecha_che" ng-model="rengTP.fecha_che" required />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>Monto</label>
                                <input type="text" class="form-control" id="mont_doc" ng-model="rengTP.mont_doc" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" />
                            </div>
                            <label ng-if="error != null && error != ''" class="text-danger text-center w-100" style="font-size: 14px;">{{ error }}</label>
                        </div>
                        <div class="col-sm-12 col-md-8">
                            <div class="controls">
                                <label>Cuenta Bancaria</label>
                                <div class="input-search">
                                    @*<input type="text" class="form-control" id="cod_cta" ng-model="rengTP.cod_cta" ng-disabled="rengTP.forma_pag == 'EF'" ng-required="rengTP.forma_pag != 'EF'" style="flex: 1;" onkeydown="prevDel(event);" />
                                        <input type="text" class="form-control" id="des_cta" ng-disabled="rengTP.forma_pag == 'EF'" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                                        <i class="fas fa-search" role="button" onclick="openModal(this, 'modalBankAccounts')" data-name="cod_cta"></i>*@
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="row" ng-if="invoice.saCliente.contribu_e">
                        <div class="col-sm-12">
                            <label>
                                <input type="checkbox" name="i_ret_iva" class="mx-2" ng-model="rengTP.isRetIVA" ng-disabled="invoice.ret_iva" ng-change="updateBalance(rengTP.isRetIVA, 'IVAN')" onclick="$('.field-iva').slideToggle()" /> Incluir Ret. IVA
                                <span ng-if="invoice.ret_iva" style="font-size: 14px;"><b> - Ya se ha aplicado Ret. IVA a esta factura</b></span>
                            </label>
                        </div>
                    </div>
                    <div class="row mt-2 field-iva" style="display: none;">
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>IVA del Documento</label>
                                <input type="text" class="form-control" id="iva_doc" ng-model="invoice.monto_imp" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>IVA del Documento</label>
                                <input type="text" class="form-control" id="iva_doc" ng-model="invoice.monto_imp_om" ng-disabled="true" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>Porc. de Retencion</label>
                                <input type="text" class="form-control" id="porc_esp" ng-model="invoice.saCliente.porc_esp" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>IVA Retenido</label>
                                <input type="text" class="form-control" id="monto_ret_imp" ng-model="invoice.monto_ret_imp" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-4">
                            <div class="controls">
                                <label>IVA Retenido</label>
                                <input type="text" class="form-control" id="monto_ret_imp" ng-model="invoice.monto_ret_imp_om" ng-disabled="true" />
                            </div>
                        </div>
                    </div>
                    <div class="row field-iva" style="display: none;">
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Fecha de Comprobante</label>
                                <input type="date" class="form-control" id="fecha_documento" ng-model="rengIVA.fecha_documento" ng-disabled="true" ng-required="rengTP.isRetIVA" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="controls">
                                <label>Num. de Comprobante (últimos 8 dígitos)</label>
                                <input type="text" class="form-control" id="num_comprobante" ng-model="rengIVA.num_comprobante" ng-disabled="!rengTP.isRetIVA" ng-required="rengTP.isRetIVA" minlength="8" maxlength="8" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-12">
                            <label>
                                <input type="checkbox" name="i_ret_islr" class="mx-2" ng-model="rengTP.isRetISLR" ng-disabled="invoice.ret_islr" ng-change="updateBalance(rengTP.isRetISLR, 'ISLR')" onclick="$('.field-islr').slideToggle()" /> Incluir Ret. ISLR
                                <span ng-if="invoice.ret_islr" style="font-size: 14px;"><b> - Ya se ha aplicado Ret. ISLR a esta factura</b></span>
                            </label>
                        </div>
                    </div>
                    <div class="row mt-2 field-islr" style="display: none;">
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Base Imp.</label>
                                <input type="text" class="form-control" id="islr_doc" ng-model="invoice.total_bruto" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Base Imp.</label>
                                <input type="text" class="form-control" id="islr_doc" ng-model="invoice.total_bruto_om" ng-disabled="true" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Concepto ISLR</label>
                                <select class="form-control" ng-model="rengISLR.co_islr" ng-change="changePorc(rengISLR.co_islr)" ng-disabled="true" style="-webkit-appearance: button; -moz-appearance: button;">
                                    <option ng-repeat="conc in conceps" value="{{ conc.co_conce }}">{{ conc.co_conce }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Porc. de Retencion</label>
                                <input type="text" class="form-control" id="porc_ret" ng-model="rengISLR.porc_retn" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Monto Retenido</label>
                                <input type="text" class="form-control" id="monto_ret_islr" ng-model="invoice.monto_reten" ng-disabled="true" />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Monto Retenido</label>
                                <input type="text" class="form-control" id="monto_ret_islr" ng-model="invoice.monto_reten_om" ng-disabled="true" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Total Fact. BSD</label>
                                <input type="text" class="form-control" ng-model="invoice.total_neto" disabled />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Total Fact. $USD</label>
                                <input type="text" class="form-control" ng-model="invoice.total_neto_om" disabled />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Base IGTF</label>
                                <input type="text" id="b_igtf" class="form-control" ng-model="invoice.b_igtf" ng-change="recalcIgtf(invoice.b_igtf)" ng-disabled="invoice.co_cond.trim() != '002'" />
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>3% IGTF</label>
                                <input type="text" id="igtf" class="form-control" ng-model="invoice.igtf" disabled />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '001'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Saldo Pendiente BSD</label>
                                <input type="text" class="form-control" ng-model="invoice.saldo_f" disabled />
                            </div>
                        </div>
                        <div ng-if="invoice.co_cond.trim() == '002'" class="col-sm-12 col-md-3">
                            <div class="controls">
                                <label>Saldo Pendiente $USD</label>
                                <input type="text" class="form-control" ng-model="invoice.saldo_f_om" disabled />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="openModalCollect()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Cobro Nuevo -->
    <div class="modal fade" id="modalCobrarNuevo" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051;">
        <form id="form-collect" class="modal-dialog" role="document" style="max-width: 1000px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header d-flex align-items-center" style="padding: 10px 20px;">
                    <h5 class="text-center fw-bold" style="margin: 10px 0">Factura N° {{ invoice.doc_num }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-collect">
                        <div class="row">
                            <div class="col-md-8 p-1">
                                <div class="border" style="height: 350px;">
                                    <table id="details-table" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Tipo</th>
                                                <th>Nro Doc.</th>
                                                <th>Banco</th>
                                                <th>Fecha</th>
                                                <th>Caja</th>
                                                <th>Cuenta</th>
                                                <th>Moneda</th>
                                                <th>Monto</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-if="rengsTP.length > 0" ng-repeat="reng in rengsTP">
                                                <td>{{ reng.reng_num }}</td>
                                                <td>{{ reng.forma_pag }}</td>
                                                <td>{{ reng.num_doc }}</td>
                                                <td>{{ reng.co_ban }}</td>
                                                <td>{{ reng.fecha_che }}</td>
                                                <td>{{ reng.cod_caja }}</td>
                                                <td>{{ reng.cod_cta }}</td>
                                                <td>{{ reng.co_mone }}</td>
                                                <td ng-if="!convertedDetails">{{ setSeparator(reng.mont_doc) }}</td>
                                                <td ng-if="convertedDetails" class="field-active">{{ setSeparator((reng.mont_doc / invoice.tasa).toFixed(2)) }}</td>
                                                <td style="width: 35px;">
                                                    <i class="fas fa-times w-100 text-center" style="font-size: 12px; color: #dc3545; cursor: pointer;" ng-click="deleteDetail(reng)"></i>
                                                </td>
                                            </tr>
                                            <tr ng-if="rengsTP.length == 0">
                                                <td colspan="10">
                                                    <p class="text-center m-0" style="font-size: 14px;">No has agregado métodos de pago</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="d-flex flex-column py-2" style="border-top: solid 1px #e8e8e8;">
                                        <p ng-if="!convertedDetails" class="m-0 px-2" style="flex: 1; font-size: 14px; text-align: right;">
                                            Total Abonado: {{ setSeparator(accumulate) }}
                                        </p>
                                        <p ng-if="convertedDetails" class="m-0 px-2 field-active" style="flex: 1; font-size: 14px; text-align: right;">
                                            Total Abonado: {{ setSeparator((accumulate / invoice.tasa).toFixed(2)) }}
                                        </p>
                                        <p ng-if="!convertedDetails" class="m-0 px-2" style="flex: 1; font-size: 14px; text-align: right;">
                                            Saldo Pendiente: {{ setSeparator(remaining) }}
                                        </p>
                                        <p ng-if="convertedDetails" class="m-0 px-2 field-active" style="flex: 1; font-size: 14px; text-align: right;">
                                            Saldo Pendiente: {{ setSeparator((remaining / invoice.tasa).toFixed(2)) }}
                                        </p>
                                        <p ng-if="!convertedDetails && change > 0" class="m-0 px-2" style="flex: 1; font-size: 14px; text-align: right;">
                                            Cambio: {{ setSeparator(change) }}
                                        </p>
                                        <p ng-if="convertedDetails && change > 0" class="m-0 px-2 field-active" style="flex: 1; font-size: 14px; text-align: right;">
                                            Cambio: {{ setSeparator((change / invoice.tasa).toFixed(2)) }}
                                        </p>
                                        <label ng-if="change > 0" class="d-flex flex-row-reverse mt-3 px-2">
                                            <input class="px-2" type="checkbox" ng-model="advance" ng-click="isAdvanced()" ng-disabled="rengsTP.length == 1 && rengsTP[0].forma_pag == 'TP' && change > 0" />
                                            <span class="my-0 mx-2" style="font-size: 14px;">Registrar cambio como adelanto</span>
                                        </label>
                                        <label ng-if="!rengIV" class="d-flex flex-row-reverse mt-3 px-2">
                                            <input class="px-2" type="checkbox" ng-model="calcRetIva" ng-click="isCalcRetIva()" />
                                            <span class="my-0 mx-2" style="font-size: 14px;">Aplicar diferencia de Ret. IVA</span>
                                        </label>
                                        <label ng-if="!rengIS" class="d-flex flex-row-reverse mt-3 px-2">
                                            <input class="px-2" type="checkbox" ng-model="calcRetIslr" ng-click="isCalcRetIslr()" />
                                            <span class="my-0 mx-2" style="font-size: 14px;">Aplicar diferencia de Ret. ISLR</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 p-1">
                                <div class="border" style="height: 350px; background: #f2f2f2;">
                                    <div class="header-totals">
                                        <h5 class="text-center fw-bold text-white py-2">Detalles</h5>
                                    </div>
                                    <div class="invoice-totals px-3">
                                        <p style="font-size: 14px;">Sub-Total</p>
                                        <p class="total-bs">{{ invoice.total_bruto }} Bs. D</p>
                                        <p class="total-usd">{{ invoice.total_bruto_om }} USD$</p>
                                    </div>
                                    <div class="invoice-totals px-3">
                                        <p style="font-size: 14px;">IVA</p>
                                        <p class="total-bs">{{ invoice.monto_imp }} Bs. D</p>
                                        <p class="total-usd">{{ invoice.monto_imp_om }} USD$</p>
                                    </div>
                                    <div class="invoice-totals px-3">
                                        <p style="font-size: 14px;">Total</p>
                                        <p class="total-bs">{{ invoice.total_neto }} Bs. D</p>
                                        <p class="total-usd">{{ invoice.total_neto_om }} USD$</p>
                                    </div>
                                    <div class="invoice-totals px-3">
                                        <p style="font-size: 14px;">I.G.T.F</p>
                                        <p class="total-bs">{{ invoice.igtf_bs }} Bs. D</p>
                                        <p class="total-usd">{{ invoice.igtf }} USD$</p>
                                    </div>
                                    <div ng-if="parse(invoice.total_neto) > parse(invoice.saldo_f)" class="invoice-totals px-3">
                                        <p style="font-size: 14px;">Saldo Abonado</p>
                                        <p class="total-bs">-{{ setSeparator(parse(invoice.total_neto) - parse(invoice.saldo_f) + parse(invoice.igtf_bs)) }} Bs. D</p>
                                        <p class="total-usd">-{{ setSeparator(parse(invoice.total_neto_om) - parse(invoice.saldo_f_om) + parse(invoice.igtf)) }} USD$</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 p-1">
                                <div class="buttons-totals" style="height: 75px;">
                                    <button class="btn" data-toggle="modal" data-target="#modalEfectivo" ng-disabled="rengCash || remaining == 0">
                                        <i class="fas fa-money-bill-alt"></i>
                                        <p class="mx-1 my-0">Efectivo USD$</p>
                                    </button>
                                    <button class="btn mx-2" data-toggle="modal" data-target="#modalTransf" ng-disabled="rengTransf || remaining == 0">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                        <p class="mx-1 my-0">Transferencia</p>
                                    </button>
                                    <button class="btn" data-toggle="modal" data-target="#modalRetenIva" ng-disabled="rengIV || remaining == 0">
                                        <i class="fas fa-file-invoice"></i>
                                        <p class="mx-1 my-0">Reten. IVA</p>
                                    </button>
                                    <button class="btn mx-2" data-toggle="modal" data-target="#modalRetenIslr" ng-disabled="rengIS || remaining == 0">
                                        <i class="fas fa-file-invoice"></i>
                                        <p class="mx-1 my-0">Reten. ISLR</p>
                                    </button>
                                    <button class="btn" style="background: #198754; flex: auto;" ng-click="convertDetails()">
                                        <i class="fas fa-exchange"></i>
                                        <p class="mx-1 my-0">Conversion</p>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 p-1">
                                <div class="d-flex align-items-center" style="height: 75px; background: #0277bd;">
                                    <div class="invoice-totals m-0 px-3">
                                        <p class="d-flex align-items-center" style="font-size: 15px; color: #FFF;">Total a pagar</p>
                                        <p class="d-flex align-items-center justify-content-end total-bs" style="font-size: 18px; color: #FFF;">{{ invoice.saldo_f }} Bs. D</p>
                                        <p class="total-usd" style="font-size: 16px; color: #FFF;">{{ invoice.saldo_f_om }} USD$</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div ng-if="invoice.ret_iva || invoice.ret_islr" class="m-0" style="flex: 1; font-size: 14px;">
                        <p ng-if="invoice.ret_iva" class="m-0 fw-bold">- Ya se ha aplicado Ret. IVA</p>
                        <p ng-if="invoice.ret_islr" class="m-0 fw-bold">- Ya se ha aplicado Ret. ISLR</p>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="addCollect()">
                        <i class="fas fa-hand-holding-usd" style="margin: 0 10px 0 0;"></i>Cobrar
                    </button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Agregar Efectivo -->
    <div class="modal fade" id="modalEfectivo" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051; background: rgba(0, 0, 0, 0.9);">
        <form id="formAddCash" class="modal-dialog" role="document" style="max-width: 600px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Efectivo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" ng-click="resetDataCash(false)">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls">
                        <label>Monto Recibido $USD</label>
                        <input type="text" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="amount_cash" ng-change="invoice.b_igtf = amount_cash; updateIgtf(amount_cash, amount_cash)" />
                    </div>
                    <div class="controls">
                        <label>Base IGTF</label>
                        <input type="text" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="invoice.b_igtf" ng-change="updateIgtf(amount_cash, invoice.b_igtf)" />
                    </div>
                    <div class="controls">
                        <label>3% IGTF</label>
                        <input type="text" onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="invoice.igtf" ng-readonly="true" ng-disabled="true" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" ng-click="resetDataCash(false)">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="addCash(amount_cash)">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Agregar Transferencia -->
    <div class="modal fade" id="modalTransf" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051; background: rgba(0, 0, 0, 0.9);">
        <form id="formAddTransf" class="modal-dialog" role="document" style="max-width: 600px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transferencia</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" ng-click="resetDataTransf()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls">
                        <label>Monto Recibido Bs. D</label>
                        <input type="text" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="amount_transf" />
                    </div>
                    <div class="controls">
                        <label>Nro. Documento</label>
                        <input type="text" required onkeypress="return (event.charCode >= 46 && event.charCode <= 57)" ng-model="num_transf" />
                    </div>
                    <div class="controls">
                        <label>Fecha</label>
                        <input type="date" required ng-model="date_transf" ng-change="console.log(date_transf)" />
                    </div>
                    <div class="controls">
                        <label>Cuenta Bancaria</label>
                        <div class="input-search">
                            <input type="text" id="cod_cta" required ng-model="cod_cta" style="flex: 1;" onkeydown="prevDel(event);" />
                            <input type="text" id="des_cta" ng-readonly="true" style="flex: 3; margin-left: 5px;" />
                            <i class="fas fa-search" role="button" onclick="openModal(this, 'modalBankAccounts')" data-name="cod_cta"></i>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" ng-click="resetDataTransf()">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="addTransf()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Agregar Reten IVA -->
    <div class="modal fade" id="modalRetenIva" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051; background: rgba(0, 0, 0, 0.9);">
        <form id="formAddRetenIva" class="modal-dialog" role="document" style="max-width: 600px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reten. IVA</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" ng-click="rengIVA.num_comprobante = ''">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls">
                        <label>IVA del Documento</label>
                        <input type="text" ng-model="invoice.monto_imp" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Porc. de Retencion</label>
                        <input type="text" ng-model="invoice.saCliente.porc_esp" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>IVA Retenido</label>
                        <input type="text" ng-model="invoice.monto_ret_imp" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Fecha de Comprobante</label>
                        <input type="date" required ng-model="rengIVA.fecha_documento" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Num. de Comprobante (últimos 8 dígitos)</label>
                        <input type="text" required ng-model="rengIVA.num_comprobante" minlength="8" maxlength="8" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" ng-click="rengIVA.num_comprobante = ''">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="addRetenIva()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal Agregar Reten ISLR -->
    <div class="modal fade" id="modalRetenIslr" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index: 1051; background: rgba(0, 0, 0, 0.9);">
        <form id="formAddRetenIslr" class="modal-dialog" role="document" style="max-width: 600px;" onsubmit="return false;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reten. ISLR</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="controls">
                        <label>Base Imp.</label>
                        <input type="text" ng-model="invoice.total_bruto" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Concepto ISLR</label>
                        <input type="text" ng-model="rengISLR.co_islr" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Porc. de Retencion</label>
                        <input type="text" ng-model="rengISLR.porc_retn" ng-disabled="true" />
                    </div>
                    <div class="controls">
                        <label>Monto Retenido</label>
                        <input type="text" ng-model="invoice.monto_reten" ng-disabled="true" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" ng-click="addRetenIslr()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal 1 -->
    <div class="modal fade" id="modalConds" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cond. Pago</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar cond. pago..." onkeyup="search('modalConds')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="cond in conds" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ cond.co_cond }}</td>
                            <td>{{ cond.cond_des }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalConds')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 2 -->
    <div class="modal fade" id="modalOrders" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Preliquidación</h5>
                    <button type="button" class="close" onclick="$('#modalWaiting').modal('hide')" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar preliquidación..." onkeyup="search('modalOrders')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="order in orders" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ order.doc_num }}</td>
                            <td>{{ order.co_cli }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="$('#modalWaiting').modal('hide');" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="$('#modalWaiting').modal('hide'); saveRow('modalOrders');">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 3 -->
    <div class="modal fade" id="modalClients" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cliente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar cliente..." onkeyup="search('modalClients')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="client in clients" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ client.co_cli }}</td>
                            <td>{{ client.cli_des }}</td>
                        </tr>
                        <tr ng-if="clients.length == 0">
                            <td colspan="2">Cargando clientes...</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalClients')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 4 -->
    <div class="modal fade" id="modalCurrencies" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Moneda</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar moneda..." onkeyup="search('modalCurrencies')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="currency in currencies" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ currency.co_mone }}</td>
                            <td>{{ currency.mone_des }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalCurrencies')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 5 -->
    <div class="modal fade" id="modalSellers" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Moneda</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar moneda..." onkeyup="search('modalSellers')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="seller in sellers" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ seller.co_ven }}</td>
                            <td>{{ seller.ven_des }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalSellers')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 6 -->
    <div class="modal fade" id="modalArts" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Articulo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar articulo..." onkeyup="search('modalArts')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="art in arts" ng-show="showItem(art)" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ art.split("/")[0] }}</td>
                            <td>{{ art.split("/")[1] }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalArts')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 7 -->
    <div class="modal fade" id="modalBankAccounts" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cuenta Bancaria</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 450px; overflow-y: auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar cuenta bancaria..." onkeyup="search('modalBankAccounts')" />
                    </div>
                    <table class="table table-bordered table-hover table-striped mt-3" id="results">
                        <tr ng-repeat="ba in bankAccounts" ng-if="ba.co_mone.trim() == 'BSD'" style="cursor: pointer" onclick="selectRow(this)">
                            <td>{{ ba.cod_cta}}</td>
                            <td>{{ ba.num_cta }} - {{ ba.co_mone }}</td>
                        </tr>
                    </table>
                    <input type="hidden" id="name-input" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRow('modalBankAccounts')">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="panel-loading p-3">
    <h4>Cargando datos...</h4>
</div>
<div class="panel-not-access p-3" style="display: none;">
    <h4>Debes abrir caja antes de iniciar a facturar</h4>
</div>
<script>
    var app = angular.module("Invoices", []);
    var user = '@ViewBag.username';
    var sucur = '@Session["BRANCH"]';
    var isNullOrEmpty = (str) => str == null || str == "";
    var invoices = @Html.Raw(ViewBag.invoices);
    var arts = @Html.Raw(ViewBag.arts);
    var conds = @Html.Raw(ViewBag.conds);
    var currencies = @Html.Raw(ViewBag.currencies);
    var sellers = @Html.Raw(ViewBag.sellers);
    var bankAccounts = @Html.Raw(ViewBag.bankAccounts);
    var us = @Html.Raw(Json.Encode(ViewBag.user));
    var curr = "US$";
    var template = @Html.Raw(ViewBag.template);
    var template_orig = @Html.Raw(ViewBag.template);
    var header = document.getElementById("header-left");
    var menu = document.getElementById("menu-left");
    var validating = false;
    var options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
    var box = '@ViewBag.id_box';

    invoices = parseItems(invoices);

    $(document).ready(function () {
        $(".container-invoices").removeAttr("style");
        $(".panel-loading").css("display", "none");

        if (!responsive)
            $("#icon-menu").trigger("click");
    });

    $(document).on("click", function (event) {
        $("#n_control").removeAttr("style");
    });

    $("#container-invoices").on("click", function (event) {
        if (event.target.id != "icon-menu" && event.target.id != "menu-left" && !responsive) {
            if ($("#menu-left.active").length == 0) {
                $("#icon-menu").trigger("click");
            }
        }
    });

    $(document).on("contextmenu", function (event) {
        event.preventDefault();
    });

    app.controller("controller", function ($scope, $http) {

        $scope.index = 0;
        $scope.numberI = 200;
        $scope.invoices = invoices;
        $scope.invoice = invoices[$scope.index];
        $scope.conds = conds;
        $scope.currencies = currencies;
        $scope.sellers = sellers;
        $scope.bankAccounts = bankAccounts;
        $scope.arts = arts;
        $scope.adding = false;
        $scope.confirm = false;
        $scope.converted = false;
        $scope.convertedDetails = false; // NUEVO
        $scope.manual = false;
        $scope.boxOpen = box != '0';
        $scope.editItem = false;
        $scope.template = template;
        $scope.user = user.trim();
        $scope.us = us;
        $scope.sucur = sucur;
        $scope.reng = {
            total_art: 1,
            reng_neto_om: (0).toFixed(2),
            monto_imp_om: (0).toFixed(2),
            prec_vta_om: "25.00",
            reng_neto_om: "25.00",
            monto_imp_om: "4.00"
        };
        // $scope.rengTP = { forma_pag: "EF", fecha_che: new Date(Date.now()) };
        $scope.rengIVA = { fecha_documento: new Date(Date.now()) };
        $scope.rengISLR = { co_islr: "055", porc_retn: "2.00" };
        $scope.conceps = [
            { co_conce: "055", porc_ret: "2.00" },
            { co_conce: "059", porc_ret: "5.00" },
            { co_conce: "063", porc_ret: "5.00" },
            { co_conce: "072", porc_ret: "3.00" },
            { co_conce: "004", porc_ret: "5.00" },
        ];
        // NUEVOS
        $scope.rengsTP = [
            //{
            //    reng_num: 1,
            //    forma_pag: "EF",
            //    num_doc: null,
            //    co_ban: null,
            //    fecha_che: new Date(Date.now()).toLocaleString("es-ES", options).replace(",", "").split(" ")[0],
            //    cod_caja: "ALPHA",
            //    cod_cta: null,
            //    co_mone: "US$",
            //    mont_doc: 210
            //}
        ];

        if (!$scope.boxOpen) {
            $(".panel-not-access").removeAttr("style");
            $(".container-invoices").css("display", "none");
        }

        $('#modalCobrar').on('hide.bs.modal', function () {

            $('#des_cta').val('');
            $('.field-iva').slideUp();
            $('.field-islr').slideUp();
            $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo));
            $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_om));
            $scope.error = "";

            if (!validating) {

                if ($scope.invoice.co_cond.trim() == "001") {
                    $scope.rengTP = { forma_pag: "TP", fecha_che: new Date(Date.now()) };
                } else {
                    $scope.rengTP = { forma_pag: "EF", fecha_che: new Date(Date.now()) };
                }

                $scope.rengIVA = { fecha_documento: new Date(Date.now()) };
                $scope.rengISLR = { co_islr: "055", porc_retn: "2.00" };
                $scope.invoice.monto_reten_om = setSeparator((parse($scope.invoice.total_bruto_om) * 0.02).toFixed(2));
                $scope.invoice.monto_reten = setSeparator((parse($scope.invoice.total_bruto) * 0.02).toFixed(2));
            }
        });

        $('#modalCobrarNuevo').on('hide.bs.modal', function () {

            $scope.rengsTP = [];
            $scope.rengCash = false;
            $scope.rengTransf = false;
            $scope.rengIV = false;
            $scope.rengIS = false;
            $scope.calcRetIva = false;
            $scope.calcRetIslr = false;
            $scope.convertedDetails = false;
        });

        $http.get("/api/ProfitTMApi/GetClients")
            .then(function (response) {
                $scope.clients = response.data.Result;
            });

        // FUNCIONES DE BOTONES
        $scope.next = function () {
            if ($scope.index == (invoices.length - 1)) {
                $scope.index = 0;
            } else {
                $scope.index++;
            }

            $scope.invoice = invoices[$scope.index];
        }

        $scope.prev = function () {
            if ($scope.index == 0) {
                $scope.index = invoices.length - 1;
            } else {
                $scope.index--;
            }

            $scope.invoice = invoices[$scope.index];
        }

        $scope.margin = function (p) {
            if (p == "s") {
                $scope.index = 0;
                $scope.invoice = invoices[0];
            } else if (p == "e") {
                $scope.index = invoices.length - 1;
                $scope.invoice = invoices[invoices.length - 1];
            }
        }

        $scope.convert = function () {
            $scope.converted = !$scope.converted;
        }

        // FUNCIONES VARIAS
        $scope.searchArt = (id) => searchArt(id);

        $scope.setSeparator = (value) => setSeparator(value);

        $scope.parse = (value) => parse(value ?? "0.00");

        // FUNCIONES DE FACTURAS CON PRELIQUIDACION
        $scope.getOrders = function () {

            $("#modalWaiting").modal("show");
            $http.get("/api/ProfitTMApi/GetOrders/" + 20)
                .then(function (response) {
                    var res = response.data;

                    if (res.Status == "OK") {
                        $scope.orders = res.Result;
                        openModal($("#btn-preliq")[0], "modalOrders");
                    } else {
                        $scope.errorMessage = res.Message;
                        $("#modalError").modal("show");
                    }
                });
        }

        $scope.detectEnter = function (e) {
            if (e.which == 13) {
                $scope.searchOrder($scope.idOrder);
            } else {
                $("#text-error").text("");
                $("#text-fail").text("");
            }
        }

        $scope.searchOrder = function (id) {

            if (isNullOrEmpty(id))
                id = $("#n_preliq").val();

            $("#text-error").text("");
            if (!isNullOrEmpty(id)) {

                $("#text-search").text("BUSCANDO PRELIQUIDACIÓN...");
                $http.get("/api/ProfitTMApi/GetOrder/" + id)
                    .then(function (response) {

                        var res = response.data;
                        if (res.Status == "OK") {

                            $("#modalSearchOrder").modal("hide");

                            $scope.invoice = res.Result;
                            $scope.invoice.saFacturaVentaReng = res.Result.saPedidoVentaReng;

                            $scope.invoice.doc_num = "";
                            $scope.invoice.n_control = "";
                            $scope.invoice = convert($scope.invoice); // AGREGAR PRECIOS OM, DESCRIPCIONES Y FECHAS

                            for (var reng of $scope.invoice.saFacturaVentaReng) {
                                reng.tipo_doc = "PCLI";
                                reng.num_doc = id;
                                reng.rowguid_doc = reng.rowguid;
                            }

                            $scope.invoice.fec_emis = new Date(Date.now());
                            $scope.invoice.fec_venc = new Date(Date.now());
                            $scope.invoice.fec_reg = new Date(Date.now());

                            $("#n_preliq").val("");
                            $("#text-error").text("");
                            $("#text-search").text("");
                            $scope.adding = true;
                            $scope.converted = true;

                        } else {
                            $scope.idOrder = "";
                            $("#n_preliq").focus();
                            $("#text-search").text("");

                            if (res.Message == "0")
                                $("#text-error").text("**PRELIQUIDACIÓN NO ENCONTRADA**");
                            else if (res.Message == "1")
                                $("#text-error").text("**PRELIQUIDACIÓN BLOQUEADA**");
                            else
                                $("#text-error").text("**HA OCURRIDO UN ERROR**");
                        }

                    }, function () {
                        $scope.idOrder = "";
                        $("#n_preliq").val("");
                        $("#n_preliq").focus();
                        $("#text-search").text("");
                        $("#text-error").text("**HA OCURRIDO UN ERROR**");
                    });

            } else {
                $("#text-error").text("**DEBES INGRESAR UN NÚMERO DE PRELIQUIDACIÓN**");
                $("#text-search").text("");
            }

        }

        $scope.deleteOrder = function (id) {

            $("#modalDelete").modal("hide");
            $("#modalWaiting").modal("show");

            $http.get("/api/ProfitTMApi/DeleteOrder/" + id)
                .then(function (response) {

                    console.log(response.data);
                    var res = response.data;

                    $("#modalWaiting").modal("hide");
                    if (res.Status == "OK") {
                        $("#modalSuccess").modal("show");
                        $scope.successMessage = "La preliquidación " + res.Result + " se ha eliminado con éxito";
                        $scope.invoice = $scope.invoices[0];
                        $scope.index = 0;

                        $scope.adding = false;
                        $scope.confirm = false;
                        $scope.converted = false;
                        $scope.idOrder = "";
                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }
                });
        }

        $scope.confirmAdd = function () {

            if ($("#form")[0].checkValidity()) {
                if (!$scope.confirm) {
                    $('#modalConfirm').modal('show');
                } else {
                    if (isNullOrEmpty($scope.invoice.n_control)) {
                        $('#modalConfirm').modal('show');
                    } else {
                        $('#modalSend').modal('show');
                    }
                }
            }
        }

        $scope.addInvoice = function () {

            if ($("#form")[0].checkValidity()) {

                $("#modalConfirm").modal("hide");
                $("#modalSend").modal("hide");
                $("#form input, #form textarea").change();
                $("#modalWaiting").modal("show");

                $scope.invoice.fec_emis = origDate($scope.invoice.fec_emis);
                $scope.invoice.fec_venc = origDate($scope.invoice.fec_venc);
                $scope.invoice.fec_reg = origDate($scope.invoice.fec_reg);

                for (var ind in $scope.invoice) {
                    if ($scope.invoice[ind] === "")
                        $scope.invoice[ind] = null;
                }

                var req = {
                    method: 'POST',
                    url: '/api/ProfitTMApi/AddInvoice/1',
                    data: $scope.invoice,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                $http(req).then(function (response) {

                    var res = response.data;
                    if (res.Status == "OK") {
                        $("#modalSuccess").modal("show");
                        $scope.addingInvoice = true;
                        $scope.successMessage = `La Factura ${res.Result.doc_num} se ha agregado con éxito`;
                        $scope.invoices.unshift(res.Result);

                        $scope.invoice = $scope.invoices[0];
                        $scope.invoice = convert($scope.invoice); // AGREGAR PRECIOS OM

                        $scope.index = 0;
                        $scope.adding = false;
                        $scope.confirm = false;
                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }

                }, function (response) {
                    $("#modalError").modal("show");
                    console.log(response);
                    $scope.errorMessage = "ERROR INTERNO -> " + response.data.ExceptionMessage;
                });

            } else {
                var id = $($("#form :invalid")[0]).closest(".form-body")[0].id;
                $("#btn-" + id).trigger("click", event);
            }
        }

        // FUNCIONES DE FACTURAS MOSTRADAS
        $scope.loadInvoices = function () {

            $scope.numberI += 200;
            $("#modalWaiting").modal("show");

            $http.get("/api/ProfitTMApi/GetInvoices/" + $scope.numberI)
                .then(function (response) {

                    var res = response.data;

                    if (res.Status == "OK") {

                        invoices = res.Result;

                        for (var i in invoices) {
                            invoices[i] = convert(invoices[i]);
                        }

                        $scope.invoices = invoices;
                        $scope.invoice = invoices[0];
                        $scope.index = 0;
                        $scope.successMessage = "Facturas cargadas con éxito";
                        $("#modalSuccess").modal("show");

                    } else {

                        $scope.errorMessage = res.Message;
                        $("#modalError").modal("show");

                    }
                });
        }

        $scope.selectInvoice = function (id) {
            if ($scope.new || $scope.adding) {
                alert("Debes terminar de agregar la factura");
            } else if ($scope.editing) {
                alert("Debes terminar de modificar la factura " + $scope.invoice.doc_num);
            } else {
                $scope.invoice = invoices.find(i => i.doc_num == id);
                $scope.index = invoices.indexOf($scope.invoice);
                $scope.invoices = invoices;
                $("#input-invoices").val("");
                searchInvoice();
            }
        }

        $scope.print = function (id) {
            location.href = '/Ventas/Procesos/ImprimirFactura?id=' + id.trim() + '&type=' + $scope.invoice.co_cond;
        }

        $scope.cancelInvoice = function (id) {

            $("#modalAnularFactura").modal("hide");
            $("#modalWaiting").modal("show");

            $http.get("/api/ProfitTMApi/CancelInvoice/" + id)
                .then(function (response) {

                    var res = response.data;
                    if (res.Status == "OK") {

                        $scope.invoice.anulado = true;
                        $scope.invoice.saldo = 0;
                        $scope.successMessage = "La factura se ha anulado con éxito";
                        $("#modalSuccess").modal("show");

                    } else {
                        $scope.errorMessage = res.Message;
                        $("#modalError").modal("show");
                    }

                });
        }

        // FUNCIONES DE FACTURA MANUAL
        $scope.initAddInvoice = function () {

            $scope.new = true;

            $scope.invoice = template;
            $scope.invoice.doc_num = "";
            $scope.invoice.n_control = "";
            $scope.invoice.status = 0;
            $scope.invoice.estatus = "NO PROCESADA";
            $scope.invoice.co_cli = template.co_cli;
            $scope.invoice.saCliente = {
                cli_des: template.saCliente.cli_des
            },
                $scope.invoice.fec_emis = new Date(Date.now()),
                $scope.invoice.fec_venc = new Date(Date.now()),
                $scope.invoice.fec_reg = new Date(Date.now()),
                $scope.invoice.saFacturaVentaReng = template.saPlantillaVentaReng;
            $scope.invoice.total_bruto = setSeparator($scope.invoice.saFacturaVentaReng.map((r) => r.reng_neto).reduce((acc, act) => acc + act, 0));
            $scope.invoice.total_bruto_om = setSeparator((parse($scope.invoice.total_bruto) / parseFloat($scope.invoice.tasa ?? 1)).toFixed(2));
            $scope.invoice.monto_imp = setSeparator($scope.invoice.saFacturaVentaReng.map((r) => r.monto_imp).reduce((acc, act) => acc + act, 0));
            $scope.invoice.monto_imp_om = setSeparator((parse($scope.invoice.monto_imp) / parseFloat($scope.invoice.tasa ?? 1)).toFixed(2));
            $scope.invoice.total_neto = setSeparator($scope.invoice.saFacturaVentaReng.map((r) => r.reng_neto + r.monto_imp).reduce((acc, act) => acc + act, 0));
            $scope.invoice.total_neto_om = setSeparator((parse($scope.invoice.total_neto) / parseFloat($scope.invoice.tasa ?? 1)).toFixed(2));
            $scope.invoice.comentario = $scope.invoice.total_neto_om;
            $scope.invoice.saldo = $scope.invoice.total_neto;
            $scope.invoice.saldo_om = $scope.invoice.total_neto_om;
            $scope.invoice.typePay = "1";
            $scope.converted = true;

            for (var r of $scope.invoice.saFacturaVentaReng) {
                r.monto_imp_om = setSeparator((r.monto_imp / $scope.invoice.tasa).toFixed(2));
                r.monto_imp = setSeparator(r.monto_imp.toFixed(2));

                r.reng_neto_om = setSeparator((r.reng_neto / $scope.invoice.tasa).toFixed(2));
                r.reng_neto = setSeparator(r.reng_neto.toFixed(2));
            }
        }

        $scope.update = function (tasa) {

            tasa = tasa == null || parseFloat(tasa) == 0 ? 1 : parseFloat(tasa);

            if ($scope.converted) {
                $scope.invoice.total_bruto = setSeparator((parse($scope.invoice.total_bruto_om) * tasa).toFixed(2));
                $scope.invoice.monto_imp = setSeparator((parse($scope.invoice.monto_imp_om) * tasa).toFixed(2));
                $scope.invoice.total_neto = setSeparator((parse($scope.invoice.total_neto_om) * tasa).toFixed(2));
                $scope.invoice.saldo = setSeparator((parse($scope.invoice.saldo_om) * tasa).toFixed(2));

                if ($scope.invoice.saFacturaVentaReng) {
                    for (var reng of $scope.invoice.saFacturaVentaReng) {
                        reng.monto_imp = setSeparator((parse(reng.monto_imp_om) * tasa).toFixed(2));
                        reng.reng_neto = setSeparator((parse(reng.reng_neto_om) * tasa).toFixed(2));
                    }
                }
            } else {
                $scope.invoice.total_bruto_om = setSeparator((parse($scope.invoice.total_bruto) / tasa).toFixed(2));
                $scope.invoice.monto_imp_om = setSeparator((parse($scope.invoice.monto_imp) / tasa).toFixed(2));
                $scope.invoice.total_neto_om = setSeparator((parse($scope.invoice.total_neto) / tasa).toFixed(2));
                $scope.invoice.saldo_om = setSeparator((parse($scope.invoice.saldo) / tasa).toFixed(2));

                if ($scope.invoice.saFacturaVentaReng) {
                    for (var reng of $scope.invoice.saFacturaVentaReng) {
                        reng.monto_imp_om = setSeparator((parse(reng.monto_imp) / tasa).toFixed(2));
                        reng.reng_neto_om = setSeparator((parse(reng.reng_neto) / tasa).toFixed(2));
                    }
                }
            }
        }

        $scope.initItem = function (edit, r) {

            $scope.editItem = edit;

            if (edit) {
                $scope.reng = r;
                $("#des_art").val(searchArt(r.co_art));
            } else {
                $scope.reng = {
                    co_art: "",
                    total_art: 1,
                    reng_neto_om: (0).toFixed(2),
                    monto_imp_om: (0).toFixed(2),
                    prec_vta_om: "25.00",
                    reng_neto_om: "25.00",
                    monto_imp_om: "4.00"
                };

                $("#art").val("");
                $("#des_art").val("");
            }

            $('#modalItem').modal('show');
        }

        $scope.showItem = function (art) {
            return $scope.invoice.saFacturaVentaReng.find(r => r.co_art.trim() == art.split('/')[0]) == null;
        }

        $scope.setItem = function (reng, action) {

            $("#modalItem form input").change();
            if ($("#modalItem form")[0].checkValidity()) {
                $scope.updateAmounts($scope.invoice, reng, $scope.invoice.saFacturaVentaReng, action);
                $("#des_art").val("");
                $("#modalItem").modal("hide");
            }
        }

        $scope.updatePriceItem = function () {

            var cant = parseFloat($scope.reng.total_art ?? 0);
            var price = parseFloat($scope.reng.prec_vta_om ?? 0);

            $scope.reng.reng_neto_om = (cant * price).toFixed(2);
            $scope.reng.monto_imp_om = ((cant * price) * 0.16).toFixed(2);
            console.log($scope.reng.reng_neto_om, $scope.reng.monto_imp_om);
        }

        $scope.updateAmounts = function (i, r, rengs, action) {

            if (action != 3) {

                if (action == 1) {
                    r.reng_num = $scope.invoice.saFacturaVentaReng.length + 1;
                    r.co_uni = "UND";
                    r.co_alma = sucur;
                    r.co_precio = "001";
                    r.tipo_imp = 1;
                    r.porc_imp = 16.00;
                }

                r.total_art = parseInt(r.total_art);
                r.pendiente = parseInt(r.total_art);

                if ($scope.manual) {
                    r.prec_vta = setSeparator(parseFloat(r.prec_vta_om).toFixed(2));
                    r.reng_neto = setSeparator(parseFloat(r.reng_neto_om).toFixed(2));
                    r.monto_imp = setSeparator(parseFloat(r.monto_imp_om).toFixed(2));
                    r.prec_vta_om = setSeparator((parse(r.prec_vta) / parseFloat(i.tasa ?? 1)).toFixed(2));
                    r.reng_neto_om = setSeparator((parse(r.reng_neto) / parseFloat(i.tasa ?? 1)).toFixed(2));
                    r.monto_imp_om = setSeparator((parse(r.monto_imp) / parseFloat(i.tasa ?? 1)).toFixed(2));
                } else {
                    r.prec_vta = setSeparator((parseFloat(r.prec_vta_om).toFixed(2) * parseFloat(i.tasa ?? 1)).toFixed(2));
                    r.reng_neto = setSeparator((parseFloat(r.reng_neto_om).toFixed(2) * parseFloat(i.tasa ?? 1)).toFixed(2));
                    r.monto_imp = setSeparator((parseFloat(r.monto_imp_om).toFixed(2) * parseFloat(i.tasa ?? 1)).toFixed(2));
                    r.prec_vta_om = setSeparator(parseFloat(r.prec_vta_om).toFixed(2));
                    r.reng_neto_om = setSeparator(parseFloat(r.reng_neto_om).toFixed(2));
                    r.monto_imp_om = setSeparator(parseFloat(r.monto_imp_om).toFixed(2));
                }
            }

            let ind = rengs.indexOf(rengs.find(i => i.reng_num == r.reng_num));
            switch (action) {
                case 1: // AGREGAR ITEM
                    rengs.push(r);
                    break;
                case 2: // EDITAR ITEM
                    rengs[ind] = r;
                    break;
                case 3: // ELIMINAR ITEM
                    rengs.splice(ind, 1);
                    break;
            }

            if (action == 3) {
                for (var r in rengs) {
                    rengs[r].reng_num = parseInt(r) + 1;
                }
            }

            i.total_bruto = setSeparator(rengs.map((r) => r.reng_neto).reduce((acc, act) => acc + parse(act), 0));
            i.total_bruto_om = setSeparator((parse(i.total_bruto) / parseFloat(i.tasa ?? 1)).toFixed(2));
            i.monto_imp = setSeparator(rengs.map((r) => r.monto_imp).reduce((acc, act) => acc + parse(act), 0));
            i.monto_imp_om = setSeparator((parse(i.monto_imp) / parseFloat(i.tasa ?? 1)).toFixed(2));
            i.total_neto = setSeparator(rengs.map((r) => parse(r.reng_neto) + parse(r.monto_imp)).reduce((acc, act) => acc + parse(setSeparator(act)), 0));
            i.total_neto_om = setSeparator((parse(i.total_neto) / parseFloat(i.tasa ?? 1)).toFixed(2));
            i.saldo = i.total_neto;
            i.saldo_om = i.total_neto_om;

            $scope.updateUSD(i.typePay);
        }

        $scope.updateUSD = function (opt) {

            var i = $scope.invoice;
            var porc_ret_iva = parseInt(i.porc_ret_iva ?? 0) / 100;
            var porc_ret_islr = parseInt(i.porc_ret_islr ?? 0) / 100;

            switch (opt) {
                case "1":
                    i.comentario = i.total_neto_om;
                    break;
                case "2":
                    var retIva = parse(i.monto_imp_om) - (parse(i.monto_imp_om) * porc_ret_iva);
                    var retIslr = parse(i.total_bruto_om) - (parse(i.total_bruto_om) * porc_ret_islr);
                    i.comentario = (retIva + retIslr).toFixed(2);
                    break;
            }
        }

        $scope.addNewInvoice = function () {

            if ($("#form")[0].checkValidity()) {
                if ($scope.invoice.saFacturaVentaReng.length > 0) {

                    $("#form input, #form textarea").change();

                    if ($scope.manual) {
                        if ($scope.invoice.doc_num.toString()[0] != 'D') {
                            alert("El numero de factura debe iniciar con D");
                            return;
                        }

                        if ($scope.invoice.n_control.toString()[0] != 'D') {
                            alert("El numero de control de la factura debe iniciar con D");
                            return;
                        }
                    }

                    $("#modalWaiting").modal("show");
                    $scope.invoice.fec_emis = origDate($scope.invoice.fec_emis);
                    $scope.invoice.fec_venc = origDate($scope.invoice.fec_venc);
                    $scope.invoice.fec_reg = origDate($scope.invoice.fec_reg);

                    for (var ind in $scope.invoice) {
                        if ($scope.invoice[ind] === "")
                            $scope.invoice[ind] = null;
                    }

                    var req = {
                        method: 'POST',
                        url: '/api/ProfitTMApi/AddInvoice/0',
                        data: $scope.invoice,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }

                    $http(req).then(function (response) {

                        var res = response.data;
                        if (res.Status == "OK") {
                            $("#modalSuccess").modal("show");
                            $scope.successMessage = `La Factura ${res.Result.doc_num} se ha agregado con éxito`;
                            $scope.invoices.unshift(res.Result);

                            $scope.invoice = $scope.invoices[0];
                            $scope.invoice = convert($scope.invoice); // AGREGAR PRECIOS OM

                            $scope.index = 0;
                            $scope.new = false;
                            $scope.manual = false;
                            template = template_orig;
                        } else {
                            $("#modalError").modal("show");
                            $scope.errorMessage = res.Message;
                        }
                    }, function (response) {
                        $("#modalError").modal("show");
                        $scope.errorMessage = "ERROR INTERNO -> " + response.data.ExceptionMessage;
                    });

                } else {
                    alert("Debes agregar items a la factura");
                }
            }
        }

        // FUNCIONES DE MODULO DE COBROS
        $scope.loadCollect = function () {
            if ($scope.addingInvoice) {
                $scope.addingInvoice = false;
                $("#modalWithCollect").modal("show");
            }
        }

        $scope.initLoadCollect = function () {

            /*if ($scope.invoice.co_cond.trim() == "001") {
                $scope.rengTP = { forma_pag: "TP", fecha_che: new Date(Date.now()) };
            } else {
                $scope.rengTP = { forma_pag: "EF", fecha_che: new Date(Date.now()) };
            }

            if ($scope.invoice.co_cond.trim() == "002" && !isNullOrEmpty($scope.invoice.comentario) && !isNaN($scope.invoice.comentario)) {
                $scope.invoice.b_igtf = setSeparator(parseFloat($scope.invoice.comentario).toFixed(2));
                $scope.invoice.igtf = (parseFloat($scope.invoice.comentario) * 0.03).toFixed(2);
                $scope.invoice.igtf_orig = (parseFloat($scope.invoice.comentario) * 0.03).toFixed(2);
                $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) + parse($scope.invoice.igtf)); // AQUI
            } else {
                $scope.invoice.b_igtf = "0.00";
                $scope.invoice.igtf = "0.00";
                $scope.invoice.igtf_orig = "0.00";
            }*/

            $scope.invoice.b_igtf = "";
            $scope.invoice.igtf = "0.00";
            $scope.invoice.igtf_bs = "0.00";
            $scope.invoice.saldo_f = $scope.invoice.saldo;
            $scope.invoice.saldo_f_om = $scope.invoice.saldo_om;
            $scope.date_transf = new Date(Date.now());
            $scope.rengIVA.num_comprobante = "";
            $scope.rengIV = $scope.invoice.ret_iva;
            $scope.rengIS = $scope.invoice.ret_islr;
            $scope.accumulate = 0;
            $scope.remaining = parse($scope.invoice.saldo_f);
            $scope.change = 0;
            $scope.advance = false;
            $scope.calcRetIva = false;
            $scope.calcRetIslr = false;

            $('#modalCobrarNuevo').modal('show');
        }

        $scope.recalcIgtf = function (value) {
            if (!isNullOrEmpty(value)) {
                // $scope.invoice.b_igtf = setSeparator(parseFloat(value).toFixed(2));
                $scope.invoice.igtf = (parseFloat(value) * 0.03).toFixed(2);
                $scope.invoice.igtf_orig = (parseFloat(value) * 0.03).toFixed(2);
            } else {
                // $scope.invoice.b_igtf = setSeparator(parseFloat($scope.invoice.comentario).toFixed(2));
                $scope.invoice.igtf = (0 * 0.03).toFixed(2);
                $scope.invoice.igtf_orig = (parseFloat($scope.invoice.comentario) * 0.03).toFixed(2);
            }

            $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_om) + parse($scope.invoice.igtf)); // AQUI

            if ($scope.rengTP.isRetIVA) {
                $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.monto_ret_imp_om));
            }

            if ($scope.rengTP.isRetISLR) {
                $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.monto_reten_om));
            }
        }

        $scope.openModalCollect = function () {

            $scope.error = "";
            if ($('#form-collect')[0].checkValidity()) {

                $("#form-collect input").change();

                var reng = $scope.rengTP;
                var amount = parseFloat(reng.mont_doc);
                var total_bs = parse($scope.invoice.saldo_f);
                var total_usd = parse($scope.invoice.saldo_f_om);
                var igtf = parse($scope.invoice.igtf);

                if (reng.forma_pag == "EF")
                    curr = "US$";
                else
                    curr = "BSD";

                reng.fecha_che = origDate(reng.fecha_che);
                reng.co_us_in = igtf;

                if (amount == 0) {
                    $scope.error = "Debes ingresar un monto mayor a 0";
                    return;
                }

                if (curr.trim() == "US$" && amount > total_usd) {
                    $("#mont_doc").focus();
                    $scope.error = "El monto no debe exceder el saldo pendiente de la factura ($" + setSeparator(total_usd) + ")";
                    return;
                } else if (curr.trim() == "BSD" && amount > total_bs) {
                    $("#mont_doc").focus();
                    $scope.error = "El monto no debe exceder el saldo pendiente de la factura (Bs. D " + setSeparator(total_bs) + ")";
                    return;
                }

                $('#modalConfirmarMonto').modal('show');
            }
        }

        $scope.changePorc = function (value) {
            //$scope.rengISLR.porc_retn = $scope.conceps.find(c => c.co_conce == value).porc_ret;
            //$scope.invoice.monto_reten = (parse($scope.invoice.total_bruto) * (parseFloat($scope.rengISLR.porc_retn) / 100)).toFixed(2);
            //$scope.invoice.monto_reten_om = (parse($scope.invoice.total_bruto_om) * (parseFloat($scope.rengISLR.porc_retn) / 100)).toFixed(2);
            //$scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo) - parse($scope.invoice.monto_reten));
            //$scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_om) - parse($scope.invoice.monto_reten_om) + parse($scope.invoice.igtf)); // AQUI

            //if ($scope.rengTP.isRetIVA) {
            //    $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) - parse($scope.invoice.monto_ret_imp));
            //    $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.monto_ret_imp_om));
            //}
        }

        $scope.updateBalance = function (value, imp) {
            if (value) {
                if (imp == "IVAN") {
                    $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) - parse($scope.invoice.monto_ret_imp));
                    $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.monto_ret_imp_om));
                } else if (imp == "ISLR") {
                    $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) - parse($scope.invoice.monto_reten));
                    $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.monto_reten_om));
                }
            } else {
                if (imp == "IVAN") {
                    $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) + parse($scope.invoice.monto_ret_imp));
                    $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) + parse($scope.invoice.monto_ret_imp_om));
                } else if (imp == "ISLR") {
                    $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) + parse($scope.invoice.monto_reten));
                    $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) + parse($scope.invoice.monto_reten_om));
                }
            }
        }

        $scope.getImpPeriod = function (date) {
            date = date.toLocaleString("es-ES", options).replace(",", "").split(" ")[0].split("/");
            return date[2] + date[1];
        }

        $scope.sendCollect = function () {

            $("#form-collect input").change();
            var reng = $scope.rengTP, rengIVA = null, rengISLR = null;

            if (reng.isRetIVA) {
                rengIVA = $scope.rengIVA;
                rengIVA.monto_ret_imp = $scope.invoice.monto_ret_imp;
                rengIVA.periodo_impositivo = $scope.getImpPeriod(rengIVA.fecha_documento);
                rengIVA.num_comprobante = rengIVA.periodo_impositivo + rengIVA.num_comprobante;
            }

            if (reng.isRetISLR) {
                rengISLR = $scope.rengISLR;
                rengISLR.monto = $scope.invoice.total_bruto;
                rengISLR.monto_obj = $scope.invoice.total_bruto;
                rengISLR.monto_reten = $scope.invoice.monto_reten;
            }

            validating = true;
            $("#modalCobrar").modal("hide");
            $("#modalConfirmarMonto").modal("hide");
            $("#modalWaiting").modal("show");
            validating = false;

            var req = {
                method: 'POST',
                url: '/api/ProfitTMApi/AddCollect/' + $scope.invoice.doc_num.trim(),
                data: [reng, rengIVA, rengISLR],
                headers: {
                    'Content-Type': 'application/json'
                },
            }

            $http(req).then(function (response) {

                var res = response.data;
                if (res.Status == "OK") {
                    $("#modalSuccess").modal("show");
                    $scope.successMessage = `El Cobro ${res.Result.cob_num} se ha agregado con éxito`;

                    $scope.invoice.status = parseInt(res.Result.campo1);
                    $scope.invoice.estatus = setStatus($scope.invoice.status);
                    $scope.invoice.saldo = setSeparator(parseFloat(res.Result.campo2.replaceAll(",", ".")));
                    $scope.invoice.saldo_f = setSeparator(parseFloat(res.Result.campo2.replaceAll(",", ".")));
                    $scope.invoice.saldo_om = setSeparator(parseFloat(res.Result.campo3.replaceAll(",", ".")));
                    $scope.invoice.saldo_f_om = setSeparator(parseFloat(res.Result.campo3.replaceAll(",", ".")));
                    $scope.invoice.ret_iva = reng.isRetIVA;
                    $scope.invoice.ret_islr = reng.isRetISLR;
                } else {
                    $("#modalError").modal("show");
                    $scope.errorMessage = res.Message;
                }

                $scope.rengIVA = { fecha_documento: new Date(Date.now()) };
                $scope.rengISLR = { co_islr: "055", porc_retn: "2.00" };
                $scope.invoice.monto_reten_om = setSeparator((parse($scope.invoice.total_bruto_om) * 0.02).toFixed(2));
                $scope.invoice.monto_reten = setSeparator((parse($scope.invoice.total_bruto) * 0.02).toFixed(2));

                $('#des_cta').val('');
                $('.field-iva').slideUp();
                $('.field-islr').slideUp();
            });
        }

        // FUNCIONES NUEVAS
        $scope.updateIgtf = function (amount, base) {
            if (parseFloat(base) <= 0 || parseFloat(base) > parseFloat(amount)) {
                alert("La base de IGTF debe ser mayor a 0 y menor o igual al monto recibido en USD$");
                $scope.invoice.b_igtf = "";
                $scope.invoice.igtf = "0.00";
                return;
            } else {
                $scope.invoice.igtf = setSeparator(parse(((base ?? 0) * 0.03).toFixed(2)));
            }
        }

        $scope.resetDataCash = function (add) {
            $scope.amount_cash = '';
            $scope.invoice.b_igtf = '';

            if (!add)
                $scope.invoice.igtf = '0.00'
        }

        $scope.resetDataTransf = function () {
            $scope.amount_transf = '';
            $scope.num_transf = '';
            $scope.cod_cta = '';
            $("#cod_cta").val("");
            $("#des_cta").val("");
        }

        $scope.addCash = function (amount) {
            if ($("#formAddCash")[0].checkValidity()) {

                // CALCULOS Y DESPLIEGUE DE IGTF

                console.log($scope.invoice.saldo_f);
                console.log($scope.invoice.saldo_f_om);
                console.log($scope.invoice.igtf_bs);
                $scope.invoice.igtf_bs = parse((parse($scope.invoice.igtf) * parseFloat($scope.invoice.tasa)).toFixed(2));
                $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) + $scope.invoice.igtf_bs);
                $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) + parse($scope.invoice.igtf));
                $scope.invoice.igtf_bs = setSeparator($scope.invoice.igtf_bs);
                console.log($scope.invoice.saldo_f);
                console.log($scope.invoice.saldo_f_om);
                console.log($scope.invoice.igtf_bs);

                // CREACION DE RENGLON
                var r = {
                    reng_num: $scope.rengsTP.length + 1,
                    forma_pag: "EF",
                    num_doc: null,
                    co_ban: null,
                    fecha_che: new Date(Date.now()).toLocaleString("es-ES", options).replace(",", "").split(" ")[0],
                    cod_caja: $scope.user,
                    cod_cta: null,
                    co_mone: "US$",
                    mont_doc: parse((amount * parseFloat($scope.invoice.tasa)).toFixed(2)),
                    mov_num_c: $scope.invoice.igtf_bs // MONTO IGTF EN BOLIVARES
                };

                // INSERCION DE RENGLON EN FORMAS DE PAGO
                $scope.rengsTP.push(r);
                $scope.accumulate = $scope.rengsTP.map((r) => r.mont_doc).reduce((acc, act) => acc + act, 0);
                $scope.remaining = parse($scope.invoice.saldo_f) - $scope.accumulate;

                if ($scope.calcRetIva)
                    $scope.remaining -= parse($scope.invoice.monto_ret_imp);

                if ($scope.calcRetIslr)
                    $scope.remaining -= parse($scope.invoice.monto_reten);

                if ($scope.remaining < 0) {
                    $scope.change = $scope.remaining * -1;
                    $scope.remaining = 0;
                }

                $scope.rengCash = true;
                $scope.convertedDetails = true;
                $scope.resetDataCash(true);
                $("#modalEfectivo").modal("hide");
            }
        }

        $scope.addTransf = function () {
            if ($("#formAddTransf")[0].checkValidity()) {
                $("#formAddTransf input").change();

                // CREACION DE RENGLON
                var r = {
                    reng_num: $scope.rengsTP.length + 1,
                    forma_pag: "TP",
                    num_doc: $scope.num_transf,
                    co_ban: searchBankAccount($scope.cod_cta).co_ban,
                    fecha_che: $scope.date_transf.toLocaleString("es-ES", options).replace(",", "").split(" ")[0],
                    cod_caja: null,
                    cod_cta: $scope.cod_cta,
                    co_mone: "BSD",
                    mont_doc: parse(parseFloat($scope.amount_transf).toFixed(2))
                };

                // INSERCION DE RENGLON EN FORMAS DE PAGO
                $scope.rengsTP.push(r);
                $scope.accumulate = $scope.rengsTP.map((r) => r.mont_doc).reduce((acc, act) => acc + act, 0);
                $scope.remaining = parse($scope.invoice.saldo_f) - $scope.accumulate;

                if ($scope.calcRetIva)
                    $scope.remaining -= parse($scope.invoice.monto_ret_imp);

                if ($scope.calcRetIslr)
                    $scope.remaining -= parse($scope.invoice.monto_reten);

                if ($scope.remaining < 0) {
                    $scope.change = $scope.remaining * -1;
                    $scope.remaining = 0;
                }

                $scope.rengTransf = true;
                $scope.convertedDetails = false;
                $scope.resetDataTransf();

                if ($scope.rengsTP.length == 1 && $scope.rengsTP[0].forma_pag == "TP" && $scope.change > 0) {
                    $scope.advance = true;
                }
                
                $("#modalTransf").modal("hide");
            }
        }

        $scope.addRetenIva = function () {
            if ($("#formAddRetenIva")[0].checkValidity()) {

                // CREACION DE RENGLON
                var r = {
                    reng_num: $scope.rengsTP.length + 1,
                    forma_pag: "IVAN",
                    num_doc: $scope.rengIVA.num_comprobante,
                    co_ban: null,
                    fecha_che: $scope.rengIVA.fecha_documento.toLocaleString("es-ES", options).replace(",", "").split(" ")[0],
                    cod_caja: null,
                    cod_cta: null,
                    co_mone: "BSD",
                    mont_doc: parse($scope.invoice.monto_ret_imp),
                    mov_num_c: $scope.getImpPeriod($scope.rengIVA.fecha_documento) // PERIODO IMPOSITIVO DE COMP. DE RETENCION
                };

                // INSERCION DE RENGLON EN FORMAS DE PAGO
                $scope.rengsTP.push(r);
                $scope.accumulate = $scope.rengsTP.map((r) => r.mont_doc).reduce((acc, act) => acc + act, 0);
                $scope.remaining = parse($scope.invoice.saldo_f) - $scope.accumulate;

                if ($scope.remaining < 0) {
                    $scope.change = $scope.remaining * -1;
                    $scope.remaining = 0;
                }

                $scope.rengIV = true;
                $scope.calcRetIva = false;
                $scope.convertedDetails = false;
                $("#modalRetenIva").modal("hide");
            }
        }

        $scope.addRetenIslr = function () {

            // CREACION DE RENGLON
            var r = {
                reng_num: $scope.rengsTP.length + 1,
                forma_pag: "ISLR",
                num_doc: $scope.rengISLR.co_islr,
                co_ban: null,
                fecha_che: new Date(Date.now()).toLocaleString("es-ES", options).replace(",", "").split(" ")[0],
                cod_caja: null,
                cod_cta: null,
                co_mone: "BSD",
                mont_doc: parse($scope.invoice.monto_reten)
            };

            // INSERCION DE RENGLON EN FORMAS DE PAGO
            $scope.rengsTP.push(r);
            $scope.accumulate = $scope.rengsTP.map((r) => r.mont_doc).reduce((acc, act) => acc + act, 0);
            $scope.remaining = parse($scope.invoice.saldo_f) - $scope.accumulate;

            if ($scope.remaining < 0) {
                $scope.change = $scope.remaining * -1;
                $scope.remaining = 0;
            }

            $scope.rengIS = true;
            $scope.calcRetIslr = false;
            $scope.convertedDetails = false;
            $("#modalRetenIslr").modal("hide");
        }

        $scope.convertDetails = function () {
            $scope.convertedDetails = !$scope.convertedDetails;
        }

        $scope.deleteDetail = function (reng) {

            let i = $scope.rengsTP.indexOf(reng);
            $scope.rengsTP.splice(i, 1);

            $scope.accumulate = $scope.rengsTP.map((r) => r.mont_doc).reduce((acc, act) => acc + act, 0);
            if (reng.forma_pag == "EF") {
                $scope.invoice.saldo_f = setSeparator(parse($scope.invoice.saldo_f) - parse($scope.invoice.igtf_bs));
                $scope.invoice.saldo_f_om = setSeparator(parse($scope.invoice.saldo_f_om) - parse($scope.invoice.igtf));
                $scope.invoice.b_igtf = "";
                $scope.invoice.igtf = "0.00";
                $scope.invoice.igtf_bs = "0.00";
                $scope.rengCash = false;
            } else if (reng.forma_pag == "TP") {
                $scope.rengTransf = false;
            } else if (reng.forma_pag == "IVAN") {
                $scope.rengIVA.num_comprobante = "";
                $scope.rengIV = false;
            } else if (reng.forma_pag == "ISLR") {
                $scope.rengIS = false;
            }

            $scope.remaining = parse($scope.invoice.saldo_f) - $scope.accumulate;
            if ($scope.calcRetIva)
                $scope.remaining -= parse($scope.invoice.monto_ret_imp);

            if ($scope.calcRetIslr)
                $scope.remaining -= parse($scope.invoice.monto_reten);

            if ($scope.remaining < 0) {
                $scope.change = $scope.remaining * -1;
                $scope.remaining = 0;
            } else {
                $scope.change = 0;
            }

            $scope.convertedDetails = false;
        }

        $scope.isAdvanced = function () {
            $scope.advance = !$scope.advance;
        }

        $scope.isCalcRetIva = function () {
            $scope.calcRetIva = !$scope.calcRetIva;

            if ($scope.calcRetIva)
                $scope.remaining -= parse($scope.invoice.monto_ret_imp) + $scope.change;
            else
                $scope.remaining += parse($scope.invoice.monto_ret_imp) - $scope.change;

            if ($scope.remaining >= 0)
                $scope.change = 0;
            else {
                $scope.change = $scope.remaining * - 1;
                $scope.remaining = 0;
            }
        }

        $scope.isCalcRetIslr = function () {
            $scope.calcRetIslr = !$scope.calcRetIslr;

            if ($scope.calcRetIslr)
                $scope.remaining -= parse($scope.invoice.monto_reten) + $scope.change;
            else
                $scope.remaining += parse($scope.invoice.monto_reten) - $scope.change;

            if ($scope.remaining >= 0)
                $scope.change = 0;
            else {
                $scope.change = $scope.remaining * - 1;
                $scope.remaining = 0;
            }
        }

        $scope.addCollect = function () {

            var rengs = $scope.rengsTP;
            if (rengs.length > 0) {
                var r_ivan = rengs.find(r => r.forma_pag == "IVAN");
                var r_islr = rengs.find(r => r.forma_pag == "ISLR");

                //if (r_ivan != null)
                //    alert("hay retencion de iva");

                //if (r_islr != null)
                //    alert("hay retencion de islr");

                //if ($scope.change > 0) {
                //    alert("hay cambio");

                //    if ($scope.advance == true)
                //        alert("cambio se registra como adelanto");
                //    else
                //        alert("cambio se devuelve");
                //}

                var cob = {
                    campo1: $scope.invoice.doc_num.trim(), // NRO.FACTURA
                    campo2: $scope.remaining,              // SALDO RESTANTE
                    campo3: $scope.change,                 // CAMBIO
                    campo4: $scope.advance,                // ADELANTO O VUELTO
                    campo5: $scope.calcRetIva,             // APLICAR DIFERENCIA DE RET IVA
                    campo6: $scope.calcRetIslr,            // APLICAR DIFERENCIA DE RET ISLR
                    saCobroTPReng: rengs                   // RENGLONES DE COBRO
                };

                $("#modalCobrarNuevo").modal("hide");
                $("#modalWaiting").modal("show");

                var req = {
                    method: 'POST',
                    url: '/api/ProfitTMApi/AddCollect2/',
                    data: cob,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                $http(req).then(function (response) {

                    var res = response.data;
                    if (res.Status == "OK") {
                        $("#modalSuccess").modal("show");
                        $scope.successMessage = `El Cobro ${res.Result.cob_num} se ha agregado con éxito`;
                        $scope.invoice.status = parseInt(res.Result.campo1);
                        $scope.invoice.estatus = setStatus($scope.invoice.status);
                        $scope.invoice.saldo = setSeparator(parseFloat(res.Result.campo2.replaceAll(",", ".")));
                        $scope.invoice.saldo_f = setSeparator(parseFloat(res.Result.campo2.replaceAll(",", ".")));
                        $scope.invoice.saldo_om = setSeparator(parseFloat(res.Result.campo3.replaceAll(",", ".")));
                        $scope.invoice.saldo_f_om = setSeparator(parseFloat(res.Result.campo3.replaceAll(",", ".")));
                        $scope.invoice.ret_iva = r_ivan != null;
                        $scope.invoice.ret_islr = r_islr != null;
                    } else {
                        $("#modalError").modal("show");
                        $scope.errorMessage = res.Message;
                    }

                    $('#des_cta').val('');
                    $('.field-iva').slideUp();
                    $('.field-islr').slideUp();
                });
            } else {
                alert("Debes agregar al menos una forma de cobro");
            }
        }
    });

    // BUSQUEDAS
    function searchCond(value) {
        return conds.find(c => c.co_cond.trim() == value.trim()).cond_des;
    }

    function searchClient(value) {
        return clients.find(c => c.co_cli == value).cli_des;
    }

    function searchSeller(value) {
        return sellers.find(s => s.co_ven.trim() == value.trim()).ven_des;
    }

    function searchBankAccount(value) {
        return bankAccounts.find(c => c.cod_cta.trim() == value.trim());
    }

    function searchArt(value) {

        var name = "";
        value = value.trim();

        for (var a of arts) {
            var code = a.split("/")[0];

            if (code == value) {
                name = a.split("/")[1];
                break;
            }
        }

        return name;
    }

    function searchInvoice() {
        var value = $("#input-invoices").val().toLowerCase(),
            table = $("#table-invoices")[0];

        for (var i = 1; i < table.rows.length; i++) {

            var row = table.rows[i];
            var elems = row.getElementsByTagName("td");

            var val1 = elems[0].innerHTML.toLocaleLowerCase(), val2 = elems[1].innerHTML.toLocaleLowerCase();

            if (!val1.includes(value) && !val2.includes(value))
                row.style.display = "none";
            else
                row.style.display = "";
        }
    }

    // FORMATO DE DATOS DE FACTURAS
    function parseItems(items_c) {

        var items = items_c;

        for (var item of items) {

            // TOTALES OM
            item.total_bruto_om = setSeparator((item.total_bruto / item.tasa).toFixed(2));
            item.total_bruto = setSeparator(item.total_bruto.toFixed(2));

            item.monto_imp_om = setSeparator((item.monto_imp / item.tasa).toFixed(2));
            item.monto_imp = setSeparator(item.monto_imp.toFixed(2));

            item.total_neto_om = setSeparator((item.total_neto / item.tasa).toFixed(2));
            item.total_neto = setSeparator(item.total_neto.toFixed(2));

            item.saldo_om = setSeparator((item.saldo / item.tasa).toFixed(2));
            item.saldo = setSeparator(item.saldo.toFixed(2));
            item.saldo_f_om = item.saldo_om;
            item.saldo_f = item.saldo;

            for (var r of item.saFacturaVentaReng) {
                r.monto_imp_om = setSeparator((r.monto_imp / item.tasa).toFixed(2));
                r.monto_imp = setSeparator(r.monto_imp.toFixed(2));

                r.reng_neto_om = setSeparator((r.reng_neto / item.tasa).toFixed(2));
                r.reng_neto = setSeparator(r.reng_neto.toFixed(2));
            }

            if (!item.contribu_e)
                item.saCliente.porc_esp = 75;

            // FECHAS
            item.fec_emis = new Date(parseInt(item.fec_emis.substr(6)));
            item.fec_venc = new Date(parseInt(item.fec_venc.substr(6)));
            item.fec_reg = new Date(parseInt(item.fec_reg.substr(6)));
            item.fe_us_in = new Date(parseInt(item.fe_us_in.substr(6)));
            item.fe_us_mo = new Date(parseInt(item.fe_us_mo.substr(6)));

            // DATOS
            item.estatus = setStatus(item.status);
            item.saCliente.porc_esp += ".00";
            item.monto_ret_imp_om = setSeparator((parse(item.monto_imp_om) * (parseFloat(item.saCliente.porc_esp ?? 75) / 100)).toFixed(2));
            item.monto_ret_imp = setSeparator((parse(item.monto_imp) * (parseFloat(item.saCliente.porc_esp ?? 75) / 100)).toFixed(2));
            item.monto_reten_om = setSeparator((parse(item.total_bruto_om) * 0.02).toFixed(2));
            item.monto_reten = setSeparator((parse(item.total_bruto) * 0.02).toFixed(2));
            item.ret_iva = item.co_us_in == "True";
            item.ret_islr = item.co_us_mo == "True";
        }

        return items;
    }

    function convert(invoice) {

        var i = invoice;

        i.total_bruto_om = setSeparator((i.total_bruto / i.tasa).toFixed(2));
        i.total_bruto = setSeparator(i.total_bruto.toFixed(2));

        i.monto_imp_om = setSeparator((i.monto_imp / i.tasa).toFixed(2));
        i.monto_imp = setSeparator(i.monto_imp.toFixed(2));

        i.total_neto_om = setSeparator((i.total_neto / i.tasa).toFixed(2));
        i.total_neto = setSeparator(i.total_neto.toFixed(2));

        i.saldo_om = setSeparator((i.saldo / i.tasa).toFixed(2));
        i.saldo = setSeparator(i.saldo.toFixed(2));
        i.saldo_f_om = i.saldo_om;
        i.saldo_f = i.saldo;

        for (var reng of i.saFacturaVentaReng) {

            if (reng.porc_imp > 0) {
                reng.monto_imp = (reng.reng_neto * 0.16);
            }

            reng.monto_imp_om = setSeparator((reng.monto_imp / i.tasa).toFixed(2));
            reng.monto_imp = setSeparator(reng.monto_imp.toFixed(2));
            reng.reng_neto_om = setSeparator((reng.reng_neto / i.tasa).toFixed(2));
            reng.reng_neto = setSeparator(reng.reng_neto.toFixed(2));
        }

        if (!i.contribu_e)
            i.saCliente.porc_esp = 75;

        i.fec_emis = new Date(i.fec_emis);
        i.fec_venc = new Date(i.fec_venc);
        i.fec_reg = new Date(i.fec_reg);
        i.fe_us_in = new Date(i.fe_us_in);
        i.fe_us_mo = new Date(i.fe_us_mo);
        i.estatus = setStatus(i.status);
        i.saCliente.porc_esp += ".00";
        i.monto_ret_imp_om = setSeparator((parse(i.monto_imp_om) * (parseFloat(i.saCliente.porc_esp) / 100)).toFixed(2));
        i.monto_ret_imp = setSeparator((parse(i.monto_imp) * (parseFloat(i.saCliente.porc_esp) / 100)).toFixed(2));
        i.monto_reten_om = setSeparator((parse(i.total_bruto_om) * 0.02).toFixed(2));
        i.monto_reten = setSeparator((parse(i.total_bruto) * 0.02).toFixed(2));
        i.ret_iva = i.co_us_in == "True";
        i.ret_islr = i.co_us_mo == "True";

        return i;
    }

    function setStatus(status) {

        var value;

        if (status == 0)
            value = "NO PROCESADA";
        else if (status == 1)
            value = "PARC. PROCESADA";
        else if (status == 2)
            value = "PROCESADA";

        return value;
    }

    function origDate(value) {

        var timeOffset = value.getTimezoneOffset() * 60000;
        var date = new Date(value.getTime() - timeOffset).toUTCString();

        return new Date(date);
    }

    // FORMATO Y CAMPOS
    function parse(value) {
        return parseFloat(value.replaceAll(',', ''));
    }

    function setSeparator(value) {
        return new Intl.NumberFormat('en-EN', { minimumFractionDigits: 2 }).format(value);
    }

    function focusField(field) {
        setTimeout(function () {
            $(field).focus();
        }, 1000);
    }

    function alertField() {
        alert('Debe agregar manualmente el Número de Control');

        setTimeout(function () {
            $("#n_control").focus();
            $("#n_control").css("background", "#ffcd95");
        }, 1000);
    }

    function prevDel(e) {
        e.preventDefault();
    }

    // MODALES
    function openModal(elem, modal) {

        var previous = elem.previousElementSibling;

        if (!previous.disabled) {
            $("#" + modal).find("#name-input").val($(elem).data("name"));
            $("#" + modal).modal("show");
        }
    }

    function search(modal) {
        var value = $("#" + modal).find("input[type=text]").val().toLowerCase(),
            table = $("#" + modal).find("#results")[0];

        for (var i = 0; i < table.rows.length; i++) {

            var row = table.rows[i];
            var elems = row.getElementsByTagName("td");

            var val1 = elems[0].innerHTML.toLocaleLowerCase(), val2 = elems[1].innerHTML.toLocaleLowerCase();

            if (!val1.includes(value) && !val2.includes(value))
                row.style.display = "none";
            else
                row.style.display = "";
        }
    }

    function selectRow(elem) {
        var previous = document.getElementsByClassName("selected-row")[0];

        if (previous != null) {
            previous.classList.remove("selected-row");
        }

        elem.classList.add("selected-row");
    }

    function saveRow(modal) {
        var item = document.getElementsByClassName("selected-row")[0];

        if (item != null) {
            var elem = item.children[0],
                value = elem.innerHTML,
                input = $("#" + modal).find("#name-input").val(),
                rows = [...($("#" + modal).find("#results")[0].rows)];

            $("#" + input).val(value.trim());
            $(".selected-row")[0].classList.remove("selected-row");
            $("#" + modal).find("input[type=text]").val("");
            $("#" + modal).find("button[name=search-btn]").trigger("click");

            if (input == "cond") {
                $("#des_cond").val(searchCond(value));
            } else if (input == "client") {
                $("#des_client").val(searchClient(value));
            } else if (input == "seller") {
                $("#des_seller").val(searchSeller(value));
            } else if (input == "art") {
                $("#des_art").val(searchArt(value));
            } else if (input == "n_preliq") {
                $("#n_preliq").change();
            } else if (input == "cod_cta") {
                $("#des_cta").val(searchBankAccount(value).num_cta + " - " + searchBankAccount(value).co_mone);
                curr = searchBankAccount(value).co_mone;
                $("#cod_cta").change();
            }

            rows.forEach(row => row.style.display = "");
            $("#" + modal).modal("hide");
        } else {
            alert("Debes seleccionar un item");
        }
    }

    // PESTAÑAS
    function openTab(e, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("form-body");

        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tablinks");

        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "flex";
        e.target.className += " active";
    }

</script>